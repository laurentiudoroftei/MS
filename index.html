<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#1d1d1f" />
<meta name="format-detection" content="telephone=no" />
<title>Mystery Shopper â€“ Standalone</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#1d1d1f; --panel:#1a1a21; --panel2:#17171c;
  --text:#ececec; --muted:#b9b9c2; --hint:#9a9aa3;
  --accent1:#7325C5; --accent2:#FF6200; --accent3:#F43C6E;
  --glass:rgba(255,255,255,0.06); --border:rgba(255,255,255,0.12);
  --ok:#2ecc71; --warn:#f1c40f; --danger:#ff4d4d;
  --radius:16px; --pad:14px;
}
*{box-sizing:border-box}
html{ -webkit-text-size-adjust:100% }
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{ overflow-y:auto; -ms-overflow-style:none; scrollbar-width:none; touch-action:pan-x pan-y; overscroll-behavior-y:none }
body::-webkit-scrollbar{ width:0; height:0 }
a,button,.tab,.btn,.mi{ -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none; user-select:none; touch-action:manipulation }
button:focus,.btn:focus,.tab:focus,.mi:focus{ outline:none; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }
::selection{ background:rgba(115,37,197,.35); color:#fff }
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}
.wrapper{max-width:1200px;margin:0 auto;padding:20px 20px calc(20px + env(safe-area-inset-bottom))}
.wrapper > section{ margin-bottom:28px }
.header{ position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(29,29,31,.96), rgba(29,29,31,.86)); backdrop-filter:blur(10px); border-bottom:1px solid var(--border) }
.header-inner{ display:flex;gap:12px;align-items:center;justify-content:space-between; padding:12px calc(16px + env(safe-area-inset-right)) 12px calc(16px + env(safe-area-inset-left)) }
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);font-size:12px;color:var(--muted)}
.title{font-weight:700;letter-spacing:.3px}
.tabs{display:flex;gap:10px;flex-wrap:wrap}
.tab{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:999px;color:var(--muted)}
.tab[disabled]{opacity:.5;pointer-events:none}
.tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white;border-color:transparent}
.btn{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:inherit; transition:transform .06s ease}
.btn:active{ transform:translateY(1px) scale(.99) }
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent3));border:none;color:#fff}
.btn.ok{background:var(--ok);border:none;color:#111}
.btn.warn{background:var(--warn);border:none;color:#111}
.btn.danger{background:var(--danger);border:none;color:#fff}
.btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
.btn.block{display:block;width:100%}
.grid{display:grid;gap:20px}
.grid.two{grid-template-columns:1fr 1fr}
@media(max-width:960px){.grid.two{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:22px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px;gap:10px;flex-wrap:wrap}
.section-title h3{margin:0;font-size:18px}
.sub{font-size:12px;color:var(--hint)}
.kv{display:flex;gap:10px;flex-wrap:wrap}
.kv .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--glass)}
.input, select, textarea{ width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;outline:none }
input,textarea,select{ -webkit-user-select:text; user-select:text }
input[type=number]{ -moz-appearance:textfield }
input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 6px}
.row{display:flex;gap:12px}
.row>*{flex:1}
hr.sep{border:none;border-top:1px dashed var(--border);margin:14px 0}
.table{width:100%;border-collapse:collapse;min-width:600px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
.table th{color:var(--muted);font-weight:600}
.pill-inline{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
.table-wrap{ width:100%; overflow:auto hidden; -ms-overflow-style:none; scrollbar-width:none }
.table-wrap::-webkit-scrollbar{ display:none }
.user-actions{ padding:8px 0 12px }
.user-actions .actions{ display:flex; gap:8px; flex-wrap:wrap }
.user-actions .divider{ margin-top:10px; border-top:1px dashed var(--border) }
.adminLayout{ display:grid; grid-template-columns: 230px 1fr; gap:20px }
@media(max-width:960px){ .adminLayout{ grid-template-columns:1fr } }
.adminMenu{ position:sticky; top:72px; height:fit-content; padding:16px; border-radius:16px; background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border) }
.adminMenu .mi{ width:100%; text-align:left; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--muted); margin-bottom:10px }
.adminMenu .mi.active{ background:linear-gradient(90deg,var(--accent1),var(--accent3)); color:#fff; border-color:transparent }
.mt-lg{ margin-top:26px } .mt-xl{ margin-top:34px }
#timerOverlay{ position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px) saturate(120%); display:none;align-items:center;justify-content:center;z-index:100 }
.timer-box{ width:min(520px,90vw);background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border);border-radius:22px;padding:22px;text-align:center }
.timer-digits{font-size:48px;font-weight:700;letter-spacing:2px;margin:6px 0 10px}
.timer-meta{font-size:13px;color:var(--muted);margin-bottom:14px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:90}
.modal-card{width:min(680px,92vw);max-height:90vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:18px;padding:18px}
.toast{ position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + env(safe-area-inset-bottom));background:#111;border:1px solid var(--border); border-radius:12px;padding:12px 16px;z-index:120;display:none }
select:focus, select:active{ background:#fff; color:#111 } option{ color:#111; background:#fff }
@media (max-width: 680px){
  .header-inner{ padding:10px calc(12px + env(safe-area-inset-right)) 10px calc(12px + env(safe-area-inset-left)) }
  .title{ font-size:14px } .tabs .tab{ padding:8px 10px; font-size:13px }
  .card{ padding:16px } .section-title h3{ font-size:16px } .row{ flex-direction:column } .table{ min-width:520px }
}
.hidden{display:none !important} .faded{opacity:.6}
.form-section-title{ margin:12px 0 8px; font-weight:700; font-size:14px; color:var(--muted); border-left:3px solid var(--accent1); padding-left:8px }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="badge">MS</div>
      <div class="title">Mystery Shopper Manager</div>
      <div id="roleBadge" class="pill-inline">Guest</div>
    </div>
    <div class="tabs">
      <button id="tabShopper" class="tab active" type="button">Shopper</button>
      <button id="tabAdmin"   class="tab"          type="button">Admin</button>
      <button id="tabAuth"    class="tab"          type="button">Login</button>
      <button id="tabProfile" class="tab hidden"   type="button">Profile</button>
      <button id="tabLogout"  class="tab hidden"   type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrapper">

  <!-- SHOPPER -->
  <section id="viewShopper" class="grid two">
    <div class="card">
      <div class="section-title">
        <h3>My Tasks</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn small" type="button" onclick="App.refreshTasks()">Refresh</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table" id="tasksTable">
          <thead><tr><th>Visit</th><th>When</th><th>Status</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="tasksEmpty" class="sub hidden">No tasks assigned yet.</div>
    </div>

    <div id="visitCard" class="card hidden">
      <div class="section-title">
        <h3 id="visitTitle">Visit</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="btnStartVisit" class="btn primary small" type="button" onclick="App.timer.start()">Start timer</button>
          <button id="btnResetVisit" class="btn small" type="button" onclick="App.timer.reset()" title="Clear times">Reset</button>
        </div>
      </div>
      <div class="kv">
        <div class="pill" id="visitStore"></div>
        <div class="pill" id="visitAddress"></div>
        <div class="pill" id="visitWindow"></div>
      </div>
      <hr class="sep" />
      <div class="row">
        <div><label>Started at</label><input id="fldStartedAt" class="input" type="text" readonly /></div>
        <div><label>Stopped at</label><input id="fldStoppedAt" class="input" type="text" readonly /></div>
        <div><label>Duration (mm:ss)</label><input id="fldDuration"  class="input" type="text" readonly /></div>
      </div>
      <div class="row">
        <div><label>Start location</label><input id="fldGeoStart" class="input" type="text" readonly /></div>
        <div><label>Stop location</label><input id="fldGeoStop"  class="input" type="text" readonly /></div>
      </div>
      <hr class="sep" />
      <div id="dynamicForm"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn"   type="button" onclick="App.saveDraft()">Save draft</button>
        <button class="btn ok" type="button" onclick="App.submitForm()">Submit to Admin</button>
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="viewAdmin" class="hidden">
    <div class="card">
      <div class="section-title">
        <h3>Admin Dashboard</h3>
        <div class="row" style="gap:8px">
          <button class="btn small"  type="button" onclick="App.admin.loadAll()">Refresh</button>
          <button class="btn small"  type="button" onclick="App.admin.backup?.()">Backup JSON</button>
          <button class="btn small"  type="button" onclick="App.admin.restore?.()">Restore JSON</button>
          <button class="btn danger small" type="button" onclick="App.admin.factoryReset?.()">Factory Reset</button>
        </div>
      </div>

      <div class="adminLayout">
        <aside class="adminMenu">
          <button class="mi active" id="miShoppers" type="button" onclick="App.admin.switchPanel('shoppers')">Shoppers</button>
          <button class="mi"        id="miForms"    type="button" onclick="App.admin.switchPanel('forms')">Forms</button>
          <button class="mi"        id="miStores"   type="button" onclick="App.admin.switchPanel('stores')">Stores</button>
        </aside>

        <div class="adminContent">
          <div id="panelForms" class="card hidden">
            <div class="section-title">
              <h3>Forms</h3>
              <div class="row" style="gap:8px">
                <button class="btn small" type="button" onclick="App.admin.addSection()">Add section</button>
                <button class="btn small" type="button" onclick="App.admin.addFieldUI()">Add field</button>
                <button class="btn ok small" type="button" onclick="App.admin.saveForm()">Save</button>
                <button class="btn small" type="button" onclick="App.ui.closeModal('formModal')">Close</button>
              </div>
            </div>
            <!-- Builder inline: Title + sections + fields -->
            <label>Form title</label>
            <input id="fbTitle" class="input" placeholder="e.g., Retail Visit v1" />
            <hr class="sep" />
            <div id="fbSections"></div>
            <hr class="sep" />
            <div id="fbFields"></div>
            <div class="sub" style="margin-top:10px">Use "Add section" & "Add field", then Save.</div>
          </div>

          <div id="panelShoppers" class="card">
            <div class="section-title"><h3>Shoppers</h3><button class="btn small" type="button" onclick="App.admin.openNewShopper()">Add</button></div>
            <div class="table-wrap">
              <table class="table" id="tblShoppers"><thead><tr><th>Name</th><th>Email</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <div id="panelStores" class="card hidden">
            <div class="section-title"><h3>Stores</h3><button class="btn small" type="button" onclick="App.admin.openNewStore()">Add</button></div>
            <div class="table-wrap">
              <table class="table" id="tblStores"><thead><tr><th>Name</th><th>City</th><th></th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-xl">
        <div class="section-title"><h3>Assignments</h3><button class="btn small" type="button" onclick="App.admin.openAssignment()">New assignment</button></div>
        <div class="table-wrap">
          <table class="table" id="tblAssign"><thead><tr><th>Shopper</th><th>Store</th><th>Form</th><th>Window</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card mt-lg">
        <div class="section-title"><h3>Submissions</h3><div class="row" style="gap:8px"><button class="btn small" type="button" onclick="App.admin.exportCSV?.()">Export CSV</button></div></div>
        <div class="table-wrap">
          <table class="table" id="tblSubm"><thead><tr><th>Visit</th><th>Shopper</th><th>Duration</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- TIMER -->
<div id="timerOverlay">
  <div class="timer-box">
    <div class="sub">Visit in progress</div>
    <div class="timer-digits" id="timerDigits">00:00</div>
    <div class="timer-meta" id="timerMeta">Started now</div>
    <div class="row"><button class="btn warn block" type="button" onclick="App.timer.stop()">Stop & unlock form</button></div>
  </div>
</div>

<!-- SIMPLE MODALS reused (Shopper/Admin) -->
<div id="shopperModal" class="modal"><div class="modal-card"></div></div>
<div id="storeModal" class="modal"><div class="modal-card"></div></div>
<div id="assignModal" class="modal"><div class="modal-card"></div></div>

<div class="toast" id="toast"></div>

<script>
/* ================= API ================= */
const API = {
  base: 'https://backend.wedaevents.com/ms-api.php',
  token: localStorage.getItem('ms_token') || null,
  async call(q, method='GET', body=null, asText=false){
    const opt={ method, headers:{'Content-Type':'application/json'} };
    if(this.token) opt.headers['Authorization']='Bearer '+this.token;
    if(body) opt.body=JSON.stringify(body);
    const r=await fetch(this.base+'?q='+encodeURIComponent(q), opt);
    if(asText) return r.text();
    const j=await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if(!r.ok||j.ok===false) throw new Error(j.error||('HTTP '+r.status));
    return j;
  },
  setToken(t){ this.token=t; localStorage.setItem('ms_token',t); },
  clearToken(){ this.token=null; localStorage.removeItem('ms_token'); }
};

/* ================= Utils ================= */
const U = {
  uid:()=>('id_'+Math.random().toString(36).slice(2)+Date.now().toString(36)),
  fmtDT(ts){ if(!ts) return ''; const n=parseInt(ts,10); return isNaN(n)?'':new Date(n).toLocaleString(); },
  pad:n=>(n<10?'0':'')+n,
  fmtDuration(sec){ sec=Math.max(0,Math.floor(sec||0)); const m=Math.floor(sec/60), s=sec%60; return U.pad(m)+':'+U.pad(s) },
  toast(msg,ms=2000){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms) }
};

/* ================= App ================= */
const App = {
  state:{ me:null, role:'Guest', timer:{running:false,start:0,interval:null}, curAssign:null, curForm:null, curSubmission:null },
  cache:{ users:[], stores:[], forms:[], assignments:[], submissions:[] },

  async init(){
    this.bindUI();
    await this.tryBootstrap();
  },
  async tryBootstrap(){
    try{
      const boot=await API.call('bootstrap','GET');
      this.ingest(boot);
      this.ui.showView(this.state.me?.role==='Admin'?'admin':'shopper');
      this.admin.loadAll();
      this.refreshTasks();
    }catch(e){ this.ui.updateAuthTabs(); }
  },
  ingest(boot){
    this.state.me=boot.me; this.ui.updateAuthTabs(); this.ui.setRole(this.state.me?.role||'Guest');
    this.cache={ users:boot.users||[], stores:boot.stores||[], forms:boot.forms||[], assignments:boot.assignments||[], submissions:boot.submissions||[] };
  },

  async softRefresh(){
    try{
      const boot=await API.call('bootstrap','GET');
      const oldSub=this.state.curSubmission?.id;
      this.ingest(boot);
      this.admin.loadAll();
      this.refreshTasks();
      if(oldSub){
        const s=this.cache.submissions.find(x=>x.id===oldSub);
        if(s){
          this.state.curSubmission=s;
          document.getElementById('fldStartedAt').value=s.started_at?U.fmtDT(s.started_at):'';
          document.getElementById('fldStoppedAt').value=s.stopped_at?U.fmtDT(s.stopped_at):'';
          document.getElementById('fldDuration').value=s.duration_sec?U.fmtDuration(s.duration_sec):'';
          document.getElementById('fldGeoStart').value=s.geo_start||'';
          document.getElementById('fldGeoStop').value=s.geo_stop||'';
        }
      }
    }catch(_){/* ignore */}
  },

  bindUI(){
    const $=sel=>document.querySelector(sel);
    $('#tabShopper').onclick = ()=>this.ui.showView('shopper');
    $('#tabAdmin').onclick   = ()=>this.ui.showView('admin');
    $('#tabAuth').onclick    = ()=>this.ui.showAuth();
    $('#tabProfile').onclick = ()=>U.toast('Profile modal moved out for simplu build');
    $('#tabLogout').onclick  = ()=>this.auth.logout();
  },

  ui:{
    showView(which){
      if(which==='admin' && (!App.state.me || App.state.me.role!=='Admin')){ U.toast('Admins only'); which='shopper'; }
      const s=id=>document.getElementById(id);
      s('viewShopper').classList.toggle('hidden', which!=='shopper');
      s('viewAdmin').classList.toggle('hidden', which!=='admin');
      document.getElementById('tabShopper').classList.toggle('active', which==='shopper');
      document.getElementById('tabAdmin').classList.toggle('active', which==='admin');
    },
    setRole(r){
      App.state.role=r||'Guest';
      const b=document.getElementById('roleBadge');
      b.textContent=r||'Guest';
      b.className='pill-inline '+(r==='Admin'?'badge-ok':r==='Shopper'?'badge-warn':'');
    },
    updateAuthTabs(){
      const me=App.state.me;
      const on=(id,flag)=>document.getElementById(id).classList.toggle('hidden',!flag);
      on('tabAuth',!me); on('tabProfile',!!me); on('tabLogout',!!me);
      const a=document.getElementById('tabAdmin');
      a.classList.toggle('hidden',!(me&&me.role==='Admin')); a.toggleAttribute('disabled',!(me&&me.role==='Admin'));
    },
    showAuth(){ U.toast('Use your credential for login or create new account'); }
  },

  /* ===== Auth ===== */
  auth:{
    async logout(){ API.clearToken(); App.state.me=null; App.ui.updateAuthTabs(); App.ui.showView('shopper'); U.toast('Logged out') }
  },

  /* ===== Shopper view ===== */
  refreshTasks(){
    const me=App.state.me; const tbody=document.querySelector('#tasksTable tbody'); tbody.innerHTML='';
    const tasks=(App.cache.assignments||[]).filter(a=>me && a.shopper_id===me.id).sort((a,b)=>(a.window_from||0)-(b.window_from||0));
    document.getElementById('tasksEmpty').classList.toggle('hidden', !!tasks.length);
    tasks.forEach(a=>{
      const store=App.cache.stores.find(s=>s.id===a.store_id); const form=App.cache.forms.find(f=>f.id===a.form_id);
      const sub=App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);
      const status=sub?(sub.status||'submitted'):(a.status||'assigned');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${store?store.name:''} â€” <span class="sub">${form?form.title:''}</span></td>
        <td>${(a.window_from?U.fmtDT(a.window_from):'') + (a.window_to?' â€“ '+U.fmtDT(a.window_to):'')}</td>
        <td>${status}</td>
        <td><button type="button" class="btn small" onclick="event.stopPropagation(); App.openAssignment('${a.id}')">Open</button></td>`;
      tbody.appendChild(tr);
    });
  },

  async openAssignment(assignId){
    const a=App.cache.assignments.find(x=>x.id===assignId); if(!a) return;
    const store=App.cache.stores.find(s=>s.id===a.store_id)||{};
    const form =App.cache.forms.find(f=>f.id===a.form_id)||{fields:[],title:'Form'};
    let sub=App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);

    if(!sub){
      const r=await API.call('submissions/upsert','POST',{assignmentId:a.id,shopperId:a.shopper_id,storeId:a.store_id,formId:a.form_id});
      await this.softRefresh(); sub=this.cache.submissions.find(s=>s.id===r.id);
    }

    this.state.curAssign=a; this.state.curForm=form; this.state.curSubmission=sub;

    document.getElementById('visitCard').classList.remove('hidden');
    document.getElementById('visitTitle').textContent=`Visit â€” ${form.title}`;
    document.getElementById('visitStore').textContent=store.name||'';
    document.getElementById('visitAddress').textContent=store.address||'';
    document.getElementById('visitWindow').textContent=(a.window_from?U.fmtDT(a.window_from):'')+(a.window_to?' â€“ '+U.fmtDT(a.window_to):'');

    document.getElementById('fldStartedAt').value=sub.started_at?U.fmtDT(sub.started_at):'';
    document.getElementById('fldStoppedAt').value=sub.stopped_at?U.fmtDT(sub.stopped_at):'';
    document.getElementById('fldDuration').value=sub.duration_sec?U.fmtDuration(sub.duration_sec):'';
    document.getElementById('fldGeoStart').value=sub.geo_start||'';
    document.getElementById('fldGeoStop').value=sub.geo_stop||'';

    const host=document.getElementById('dynamicForm'); host.innerHTML='';
    const sections=(form.sections&&form.sections.length)?[...form.sections].sort((a,b)=>(a.ord??0)-(b.ord??0)):[{id:null,title:null,fields:form.fields||[]}];

    const anyLinked=sections.some(s=>(s.fields||[]).length);
    let sectionsToRender=sections;
    if(!anyLinked && (form.fields||[]).length && sections.length){
      const firstId=sections[0].id;
      sectionsToRender=sections.map(s=>({...s, fields:(form.fields||[]).filter(f=>(f.sectionId||firstId)===s.id)}));
    }

    sectionsToRender.forEach(sec=>{
      if(sec.title){ const h=document.createElement('div'); h.className='form-section-title'; h.textContent=sec.title; host.appendChild(h); }
      const fieldsIn=sec.fields && sec.fields.length ? sec.fields : (form.fields||[]).filter(ff=>(ff.sectionId||null)===(sec.id||null));
      fieldsIn.forEach(f=>{
        const wrap=document.createElement('div'); wrap.style.marginBottom='10px';
        wrap.innerHTML=`<label>${f.label}${f.required? ' <span class="sub">(required)</span>':''}</label>`;
        let el=null; const val=(sub.values||{})[f.id]??'';
        if(f.type==='textarea'){ el=document.createElement('textarea'); el.className='input'; el.rows=3; el.value=val; }
        else if(f.type==='number' || f.type==='rating'){ el=document.createElement('input'); el.className='input'; el.type='number'; el.value=val; if(f.type==='rating'){ el.min=1; el.max=5; el.step=1; el.placeholder='1-5' } }
        else if(f.type==='yesno'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option><option>Yes</option><option>No</option>'; el.value=val; }
        else if(f.type==='select'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option>'+ (f.options||[]).map(o=>`<option>${o}</option>`).join(''); el.value=val; }
        else { el=document.createElement('input'); el.className='input'; el.value=val; }
        let t=null; el.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>App.submission.saveField(f.id, el.value), 350); };
        wrap.appendChild(el); host.appendChild(wrap);
      });
    });
  },

  submission:{
    async saveField(fid,val){
      const s=App.state.curSubmission; if(!s) return;
      await API.call('submissions/update-values','PATCH',{id:s.id,patch:{[fid]:val}});
      const loc=App.cache.submissions.find(x=>x.id===s.id); if(loc){ loc.values=loc.values||{}; loc.values[fid]=val; }
    }
  },

  async saveDraft(){ const s=this.state.curSubmission; if(!s) return;
    await API.call('submissions/upsert','POST',{id:s.id,status:'draft'}); await this.softRefresh(); U.toast('Draft saved') },

  async submitForm(){ const s=this.state.curSubmission, f=this.state.curForm; if(!s||!f) return;
    if(!s.started_at||!s.stopped_at) return U.toast('Stop the timer before submitting');
    await API.call('submissions/upsert','POST',{id:s.id,status:'submitted',submittedAt:Date.now()});
    await this.softRefresh(); U.toast('Submitted') },

  /* ===== Timer ===== */
  timer:{
    async start(){
      const s=App.state.curSubmission; if(!s) return U.toast('Open a task first');
      if(s.started_at) return U.toast('Timer already started');
      let geo=null; if(navigator.geolocation){ try{ geo=await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r(p),_=>r(null))); }catch(_){ } }
      const started=Date.now();
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:started, geoStart: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null});
      App.state.timer.running=true; App.state.timer.start=started;
      document.getElementById('timerOverlay').style.display='flex';
      App.state.timer.interval=setInterval(()=>{
        const secs=(Date.now()-App.state.timer.start)/1000;
        document.getElementById('timerDigits').textContent=U.fmtDuration(secs);
        document.getElementById('timerMeta').textContent='Started at '+U.fmtDT(App.state.timer.start);
      },250);
      await App.softRefresh(); // refresh subtil dupÄƒ start
    },
    async stop(){
      const s=App.state.curSubmission; if(!s||!App.state.timer.running) return;
      let geo=null; if(navigator.geolocation){ try{ geo=await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r(p),_=>r(null))); }catch(_){ } }
      const stopped=Date.now(); const dur=Math.floor((stopped-App.state.timer.start)/1000);
      await API.call('submissions/upsert','POST',{id:s.id, stoppedAt:stopped, durationSec:dur, geoStop: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null });
      clearInterval(App.state.timer.interval); App.state.timer.running=false;
      document.getElementById('timerOverlay').style.display='none';
      await App.softRefresh(); U.toast('Timer stopped');
    },
    async reset(){
      const s=App.state.curSubmission; if(!s) return; if(App.state.timer.running) return U.toast('Stop timer first');
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:null, stoppedAt:null, durationSec:null, geoStart:'', geoStop:''});
      await App.softRefresh(); U.toast('Visit times cleared');
    }
  },

  /* ===== Admin ===== */
  admin:{
    selectedPanel:'shoppers',
    switchPanel(which){
      this.selectedPanel=which;
      ['forms','shoppers','stores'].forEach(p=>{
        document.getElementById('panel'+p.charAt(0).toUpperCase()+p.slice(1)).classList.toggle('hidden', p!==which);
        document.getElementById('mi'+p.charAt(0).toUpperCase()+p.slice(1)).classList.toggle('active', p===which);
      });
      if(which==='forms'){ App.admin.openFormBuilder(App.cache.forms[0]?.id||null); }
    },

    loadAll(){
      // shoppers
      const ts=document.querySelector('#tblShoppers tbody'); if(ts){ ts.innerHTML='';
        (App.cache.users||[]).forEach(u=>{
          const info=document.createElement('tr');
          info.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.status} <span class="pill-inline">${u.role}</span></td><td></td>`;
          ts.appendChild(info);
          const actions=document.createElement('tr'); actions.className='user-actions';
          actions.innerHTML=`<td colspan="4"><div class="actions">
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','active')">Activate</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','pending')">Pending</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','disabled')">Disable</button>
              <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteUser('${u.id}')">Delete</button>
            </div><div class="divider"></div></td>`;
          ts.appendChild(actions);
        });
      }
      // stores
      const tstore=document.querySelector('#tblStores tbody'); if(tstore){ tstore.innerHTML='';
        (App.cache.stores||[]).forEach(s=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${s.name}</td><td>${s.city||''}</td>
            <td><button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.editStore('${s.id}')">Edit</button>
                <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteStore('${s.id}')">Delete</button></td>`;
          tstore.appendChild(tr);
        });
      }
      // assignments
      const ta=document.querySelector('#tblAssign tbody'); if(ta){ ta.innerHTML='';
        (App.cache.assignments||[]).forEach(a=>{
          const sh=App.cache.users.find(u=>u.id===a.shopper_id);
          const st=App.cache.stores.find(s=>s.id===a.store_id);
          const f =App.cache.forms.find(x=>x.id===a.form_id);
          const sub=App.cache.submissions.find(s=>s.assignment_id===a.id);
          const status=sub?(sub.status||'submitted'):(a.status||'assigned');
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${sh?sh.name:''}</td><td>${st?st.name:''}</td><td>${f?f.title:''}</td>
            <td>${(a.window_from?U.fmtDT(a.window_from):'') + (a.window_to?' â€“ '+U.fmtDT(a.window_to):'')}</td>
            <td>${status}</td>
            <td>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.openAssignment('${a.id}')">Open</button>
              <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteAssignment('${a.id}')">Delete</button>
            </td>`;
          ta.appendChild(tr);
        });
      }
      // submissions
      const tsu=document.querySelector('#tblSubm tbody'); if(tsu){ tsu.innerHTML='';
        (App.cache.submissions||[]).forEach(s=>{
          const st=App.cache.stores.find(o=>o.id===s.store_id)||{}; const sh=App.cache.users.find(o=>o.id===s.shopper_id)||{};
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${st.name||''}</td><td>${sh.name||''}</td><td>${s.duration_sec?U.fmtDuration(s.duration_sec):''}</td>
            <td>${s.status||''}</td>
            <td>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.viewSubmission('${s.id}')">View</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.markSubmission('${s.id}','approved')">Approve</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.markSubmission('${s.id}','rejected')">Reject</button>
              <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteSubmission('${s.id}')">Delete</button>
            </td>`;
          tsu.appendChild(tr);
        });
      }
    },

    /* ---- minimal forms builder (inline) ---- */
    _editingFormId:null, _fbForm:{id:null,title:'',sections:[],fields:[]},

    openFormBuilder(id=null){
      this._editingFormId=id;
      if(id){
        const f=App.cache.forms.find(x=>x.id===id);
        const sections=(f.sections&&f.sections.length)?JSON.parse(JSON.stringify(f.sections)):[{id:U.uid(),title:'General',ord:0,fields:[]}];
        const fields=(f.fields||[]).map(x=>({...x}));
        fields.forEach(fd=>{ if(!fd.sectionId) fd.sectionId=sections[0].id; });
        this._fbForm={ id:f.id, title:f.title, sections, fields };
      }else{
        this._fbForm={ id:null, title:'', sections:[{id:U.uid(),title:'General',ord:0,fields:[]}], fields:[] };
      }
      document.getElementById('fbTitle').value=this._fbForm.title||'';
      this.renderFBSections(); this.renderFBFields();
      this.switchPanel('forms');
    },
    renderFBSections(){
      const host=document.getElementById('fbSections'); host.innerHTML='';
      const form=this._fbForm;
      if(!form.sections.length){ host.innerHTML='<div class="sub">No sections yet. Click "Add section".</div>'; return; }
      form.sections.sort((a,b)=>(a.ord??0)-(b.ord??0)).forEach((s,idx)=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
        <div class="section-title"><h3>Section ${idx+1}</h3>
          <div class="row" style="gap:6px">
            <button type="button" class="btn small" onclick="App.admin.moveSection(${idx},-1)">â†‘</button>
            <button type="button" class="btn small" onclick="App.admin.moveSection(${idx},1)">â†“</button>
            <button type="button" class="btn danger small" onclick="App.admin.delSection(${idx})">Delete</button>
          </div></div>
        <label>Title</label>
        <input class="input" value="${s.title||''}" oninput="App.admin.updateSectionTitle(${idx}, this.value)" />
        <div class="sub">ID: ${s.id}</div>`;
        host.appendChild(card);
      });
    },
    addSection(){ const f=this._fbForm; f.sections.push({id:U.uid(),title:'New section',ord:f.sections.length,fields:[]}); this.renderFBSections(); this.renderFBFields(); },
    moveSection(i,dir){ const a=this._fbForm.sections; const j=i+dir; if(j<0||j>=a.length) return; [a[i],a[j]]=[a[j],a[i]]; a.forEach((s,k)=>s.ord=k); this.renderFBSections(); this.renderFBFields(); },
    delSection(i){ const f=this._fbForm; if(f.sections.length===1) return U.toast('At least one section'); const rem=f.sections.splice(i,1)[0]; f.fields.forEach(fd=>{ if(fd.sectionId===rem.id) fd.sectionId=f.sections[0].id }); f.sections.forEach((s,k)=>s.ord=k); this.renderFBSections(); this.renderFBFields(); },
    updateSectionTitle(i,v){ this._fbForm.sections[i].title=v },

    renderFBFields(){
      const host=document.getElementById('fbFields'); host.innerHTML='';
      const form=this._fbForm;
      if(!form.fields.length){ host.innerHTML='<div class="sub">No fields yet. Click "Add field".</div>'; return; }
      const sectionOptions=form.sections.sort((a,b)=>(a.ord??0)-(b.ord??0)).map(s=>`<option value="${s.id}">${s.title}</option>`).join('');
      form.fields.forEach((f,idx)=>{
        const box=document.createElement('div'); box.className='card';
        box.innerHTML=`
          <div class="section-title"><h3>Field ${idx+1}</h3>
            <div class="row" style="gap:6px">
              <button type="button" class="btn small" onclick="App.admin.moveField(${idx},-1)">â†‘</button>
              <button type="button" class="btn small" onclick="App.admin.moveField(${idx},1)">â†“</button>
              <button type="button" class="btn danger small" onclick="App.admin.delField(${idx})">Delete</button>
            </div></div>
          <div class="row">
            <div><label>Label</label><input class="input" value="${f.label||''}" oninput="App.admin.updateField(${idx},'label',this.value)"/></div>
            <div><label>Type</label>
              <select class="input" onchange="App.admin.updateField(${idx},'type',this.value)">
                ${['text','textarea','number','yesno','select','rating'].map(t=>`<option ${f.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div><label>Required</label>
              <select class="input" onchange="App.admin.updateField(${idx},'required',this.value==='true')">
                <option value="false" ${!f.required?'selected':''}>No</option>
                <option value="true"  ${f.required?'selected':''}>Yes</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>Section</label><select class="input" onchange="App.admin.updateField(${idx},'sectionId',this.value)">${sectionOptions}</select></div>
            <div ${f.type==='select'?'':'class="hidden"'} id="opt_${idx}">
              <label>Options (comma separated)</label>
              <input class="input" value="${(f.options||[]).join(', ')}" oninput="App.admin.updateOptions(${idx}, this.value)"/>
            </div>
          </div>
          <div class="sub">ID: ${f.id}</div>`;
        host.appendChild(box);
        const sel=box.querySelector('select.input[onchange*="sectionId"]'); if(sel) sel.value=f.sectionId || (form.sections[0]&&form.sections[0].id);
      });
    },
    addFieldUI(){ const d=this._fbForm.sections[0]?.id || U.uid(); if(!this._fbForm.sections.length){ this._fbForm.sections.push({id:d,title:'General',ord:0,fields:[]}) } this._fbForm.fields.push({id:U.uid(),label:'New field',type:'text',required:false,options:[],sectionId:d}); this.renderFBFields(); },
    moveField(i,dir){ const a=this._fbForm.fields; const j=i+dir; if(j<0||j>=a.length) return; [a[i],a[j]]=[a[j],a[i]]; this.renderFBFields(); },
    delField(i){ this._fbForm.fields.splice(i,1); this.renderFBFields(); },
    updateField(i,k,v){ this._fbForm.fields[i][k]=v; if(k==='type') setTimeout(()=>this.renderFBFields(),0) },
    updateOptions(i,raw){ this._fbForm.fields[i].options=raw.split(',').map(s=>s.trim()).filter(Boolean) },
    async saveForm(){
      const title=document.getElementById('fbTitle').value.trim(); if(!title) return U.toast('Title required');
      const f=this._fbForm; f.sections.forEach((s,idx)=>s.ord=idx);
      const payload={ id:f.id||null, title, sections:f.sections.map(s=>({id:s.id,title:s.title,ord:s.ord})),
        fields:f.fields.map((fd,idx)=>({id:fd.id,label:fd.label,type:fd.type,required:!!fd.required,options:fd.options||[],sectionId:fd.sectionId||f.sections[0].id,ord:idx})) };
      await API.call('forms/save','POST',payload); await App.softRefresh(); U.toast('Form saved');
    },

    /* stores & users & assignments (CRUD scurt) */
    openNewShopper(){ U.toast('Add shopper modal not included in short build') },
    async userSetStatus(id,status){ await API.call('users/update','PATCH',{id,status}); await App.softRefresh(); U.toast('User '+status) },
    async deleteUser(id){ await API.call('users/delete','DELETE',{id}); await App.softRefresh(); U.toast('User deleted') },

    openNewStore(){ U.toast('New store modal not included in short build') },
    editStore(_){ U.toast('Edit store modal not included in short build') },
    async saveNewStore(){},
    async deleteStore(id){ await API.call('stores/delete','DELETE',{id}); await App.softRefresh(); U.toast('Store deleted') },

    openAssignment(){ U.toast('Assignment modal not included in short build') },
    async deleteAssignment(id){ await API.call('assignments/delete','DELETE',{id}); await App.softRefresh(); U.toast('Assignment deleted') },

    async markSubmission(id,state){ await API.call('submissions/mark','PATCH',{id,status:state}); await App.softRefresh(); U.toast('Submission '+state) },
    async deleteSubmission(id){ await API.call('submissions/delete','DELETE',{id}); await App.softRefresh(); U.toast('Submission deleted') },

    viewSubmission(id){
      const s=App.cache.submissions.find(x=>x.id===id); if(!s) return U.toast('Missing');
      const st=App.cache.stores.find(o=>o.id===s.store_id)||{}, f=App.cache.forms.find(o=>o.id===s.form_id)||{fields:[],title:'Form'}, sh=App.cache.users.find(o=>o.id===s.shopper_id)||{};
      const esc=v=>(v==null?'':String(v).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])));
      const nl2br=v=>esc(v).replace(/\n/g,'<br>');
      const star=n=>{ const v=Math.max(1,Math.min(5,parseInt(n||0,10)||0)); return `<span style="font-size:16px">${'â˜…'.repeat(v)}${'â˜†'.repeat(5-v)}</span><span style="margin-left:6px;font-size:12px;color:#666">${v}/5</span>`; };
      const valueFor=(fld,val)=> val==null||val===''?'<span style="color:#999">â€“</span>':(fld.type==='textarea'?nl2br(val):fld.type==='rating'?star(val):esc(val));
      const rows=(f.fields||[]).map(fl=>`<tr><th>${esc(fl.label)}</th><td>${valueFor(fl,(s.values||{})[fl.id])}</td></tr>`).join('')||`<tr><td colspan="2" style="color:#777;padding:12px 0">No fields</td></tr>`;
      const doc=window.open('','_blank');
      doc.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Submission ${esc(s.id)}</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>:root{--ink:#111;--muted:#6b7280;--paper:#FAFAFC;--line:#e5e7eb;--card:#fff}*{box-sizing:border-box}html,body{margin:0;background:var(--paper);color:var(--ink);font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}.container{max-width:900px;margin:0 auto;padding:28px 20px 60px}.doc{background:var(--card);border:1px solid var(--line);border-radius:14px}.head{padding:22px 22px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}.logo{width:34px;height:34px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:700}.chips{display:flex;gap:8px;flex-wrap:wrap}.chip{padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#374151;background:#fff}.meta{padding:14px 22px 8px;display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:800px){.meta{grid-template-columns:1fr}}.toolbar{padding:10px 22px;display:flex;gap:8px;border-bottom:1px solid var(--line)}.btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:13px}.btn.primary{background:#111;color:#fff;border-color:#111}.content{padding:16px 22px 26px}table{width:100%;border-collapse:collapse}th,td{text-align:left;vertical-align:top;padding:10px 8px;border-bottom:1px solid var(--line)}th{width:28%;color:#374151;font-weight:600}.foot{padding:14px 22px;border-top:1px solid var(--line);color:#6b7280;font-size:12px}@media print{.toolbar{display:none}body{background:#fff}.doc{box-shadow:none}}</style></head><body>
<div class="container"><div class="doc">
<div class="head"><div style="display:flex;gap:10px;align-items:center"><div class="logo">MS</div><div><h1 style="font-size:18px;margin:0">Submission <span style="color:#6b7280">#${esc(s.id)}</span></h1>
<div class="chips"><span class="chip"><b>Form:</b> ${esc(f.title)}</span><span class="chip"><b>Store:</b> ${esc(st.name||'')}</span><span class="chip"><b>Shopper:</b> ${esc(sh.name||'')}</span><span class="chip">${esc(s.status||'')}</span></div></div></div>
<div style="color:#6b7280">Generated: ${esc(new Date().toLocaleString())}</div></div>
<div class="meta"><div><b>Started:</b> ${esc(U.fmtDT(s.started_at))}</div><div><b>Stopped:</b> ${esc(U.fmtDT(s.stopped_at))}</div><div><b>Duration:</b> ${esc(U.fmtDuration(s.duration_sec||0))}</div><div><b>Geo:</b> ${esc(s.geo_start||'â€“')} â†’ ${esc(s.geo_stop||'â€“')}</div></div>
<div class="toolbar"><button class="btn primary" onclick="window.print()">Print</button><button class="btn" onclick="window.close()">Close</button></div>
<div class="content"><table>${rows}</table></div>
<div class="foot">Stored in MySQL (live API).</div></div></div>
<script>(function(){})();<\/script></body></html>`); doc.document.close();
    }
  }
};

window.addEventListener('load', ()=>App.init());
</script>
</body>
</html>
