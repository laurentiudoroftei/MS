<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#1d1d1f" />
<meta name="format-detection" content="telephone=no" />
<title>Mystery Shopper – Standalone</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#1d1d1f; --panel:#1a1a21; --panel2:#17171c;
  --text:#ececec; --muted:#b9b9c2; --hint:#9a9aa3;
  --accent1:#7325C5; --accent2:#FF6200; --accent3:#F43C6E;
  --glass:rgba(255,255,255,0.06); --border:rgba(255,255,255,0.12);
  --ok:#2ecc71; --warn:#f1c40f; --danger:#ff4d4d;
  --radius:16px;
}
*{box-sizing:border-box}
html{ -webkit-text-size-adjust:100% }
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{ overflow-y:auto; -ms-overflow-style:none; scrollbar-width:none; touch-action:pan-x pan-y; overscroll-behavior-y:none }
body::-webkit-scrollbar{ width:0; height:0 }
a,button,.tab,.btn,.navpill{ -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none; user-select:none; touch-action:manipulation }
button:focus,.btn:focus,.tab:focus,.navpill:focus{ outline:none; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }
::selection{ background:rgba(115,37,197,.35); color:#fff }
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}

/* layout */
.wrapper{max-width:1200px;margin:0 auto;padding:20px 20px calc(20px + env(safe-area-inset-bottom))}
.wrapper > section{ margin-bottom:28px }

/* header */
.header{ position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(29,29,31,.96), rgba(29,29,31,.86)); backdrop-filter:blur(10px); border-bottom:1px solid var(--border) }
.header-inner{ display:flex; align-items:center; gap:12px; padding:12px calc(16px + env(safe-area-inset-right)) 12px calc(16px + env(safe-area-inset-left)) }
.brand{display:flex;align-items:center;gap:10px; min-width:200px}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);font-size:12px;color:var(--muted)}
.title{font-weight:700;letter-spacing:.3px}
.admin-nav{ flex:1; display:flex; justify-content:center; gap:8px; flex-wrap:wrap }
.navpill{background:var(--panel);border:1px solid var(--border);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px}
.navpill.active{ background:linear-gradient(90deg,var(--accent1),var(--accent3)); color:#fff; border-color:transparent }
.tabs{display:flex;gap:10px;flex-wrap:wrap; min-width:240px; justify-content:flex-end}
.tab{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:999px;color:var(--muted)}
.tab[disabled]{opacity:.5;pointer-events:none}
.tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white;border-color:transparent}

/* cards / table */
.btn{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:inherit; transition:transform .06s ease}
.btn:active{ transform:translateY(1px) scale(.99) }
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent3));border:none;color:#fff}
.btn.ok{background:var(--ok);border:none;color:#111}
.btn.warn{background:var(--warn);border:none;color:#111}
.btn.danger{background:var(--danger);border:none;color:#fff}
.btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
.btn.block{display:block;width:100%}
.grid{display:grid;gap:20px}
.grid.two{grid-template-columns:1fr 1fr}
@media(max-width:960px){.grid.two{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;padding:22px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px;gap:10px;flex-wrap:wrap}
.section-title h3{margin:0;font-size:18px}
.sub{font-size:12px;color:var(--hint)}
.kv{display:flex;gap:10px;flex-wrap:wrap}
.kv .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06)}
.input, select, textarea{ width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;outline:none }
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 6px}
.row{display:flex;gap:12px}
.row>*{flex:1}
hr.sep{border:none;border-top:1px dashed var(--border);margin:14px 0}
.table{width:100%;border-collapse:collapse;min-width:600px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
.table th{color:var(--muted);font-weight:600}
.table-wrap{ width:100%; overflow:auto hidden; -ms-overflow-style:none; scrollbar-width:none }
.table-wrap::-webkit-scrollbar{ display:none }
.pill-inline{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
.user-actions{ padding:8px 0 12px }
.user-actions .actions{ display:flex; gap:8px; flex-wrap:wrap }
.user-actions .divider{ margin-top:10px; border-top:1px dashed var(--border) }

/* timer */
#timerOverlay{ position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px) saturate(120%); display:none;align-items:center;justify-content:center;z-index:100 }
.timer-box{ width:min(520px,90vw);background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border);border-radius:22px;padding:22px;text-align:center }
.timer-digits{font-size:48px;font-weight:700;letter-spacing:2px;margin:6px 0 10px}
.timer-meta{font-size:13px;color:var(--muted);margin-bottom:14px}

/* modals & toast */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:90}
.modal-card{width:min(760px,92vw);max-height:90vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:18px;padding:18px}
.toast{ position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + env(safe-area-inset-bottom));background:#111;border:1px solid var(--border); border-radius:12px;padding:12px 16px;z-index:120;display:none }

/* select open: white bg, black text */
select:focus, select:active{ background:#fff; color:#111 } option{ color:#111; background:#fff }

/* mobile tweaks */
@media (max-width: 680px){
  .header-inner{ padding:10px calc(12px + env(safe-area-inset-right)) 10px calc(12px + env(safe-area-inset-left)) }
  .title{ font-size:14px } .tab{ padding:8px 10px; font-size:13px }
  .navpill{ padding:6px 10px; font-size:12px }
  .card{ padding:16px } .section-title h3{ font-size:16px } .row{ flex-direction:column } .table{ min-width:520px }
}
.hidden{display:none !important}
.form-section-title{ margin:12px 0 8px; font-weight:700; font-size:14px; color:var(--muted); border-left:3px solid var(--accent1); padding-left:8px }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="badge">MS</div>
      <div class="title">Mystery Shopper Manager</div>
      <div id="roleBadge" class="pill-inline">Guest</div>
    </div>

    <!-- ADMIN NAV (CENTRU) -->
    <div id="adminNav" class="admin-nav hidden">
      <button class="navpill active" id="navShoppers"    type="button" onclick="App.admin.switchPanel('shoppers')">Shoppers</button>
      <button class="navpill"        id="navForms"       type="button" onclick="App.admin.switchPanel('forms')">Forms</button>
      <button class="navpill"        id="navStores"      type="button" onclick="App.admin.switchPanel('stores')">Stores</button>
      <button class="navpill"        id="navAssignments" type="button" onclick="App.admin.switchPanel('assignments')">Assignments</button>
      <button class="navpill"        id="navSubmissions" type="button" onclick="App.admin.switchPanel('submissions')">Submissions</button>
    </div>

    <div class="tabs">
      <button id="tabShopper" class="tab active" type="button">Shopper</button>
      <button id="tabAdmin"   class="tab"          type="button">Admin</button>
      <button id="tabAuth"    class="tab"          type="button">Login</button>
      <button id="tabProfile" class="tab hidden"   type="button">Profile</button>
      <button id="tabLogout"  class="tab hidden"   type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrapper">

  <!-- SHOPPER -->
  <section id="viewShopper" class="grid two">
    <div class="card">
      <div class="section-title">
        <h3>My Tasks</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn small" type="button" onclick="App.refreshTasks()">Refresh</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table" id="tasksTable">
          <thead><tr><th>Visit</th><th>When</th><th>Status</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="tasksEmpty" class="sub hidden">No tasks assigned yet.</div>
    </div>

    <div id="visitCard" class="card hidden">
      <div class="section-title">
        <h3 id="visitTitle">Visit</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="btnStartVisit" class="btn primary small" type="button" onclick="App.timer.start()">Start timer</button>
          <button id="btnResetVisit" class="btn small" type="button" onclick="App.timer.reset()" title="Clear times">Reset</button>
        </div>
      </div>
      <div class="kv">
        <div class="pill" id="visitStore"></div>
        <div class="pill" id="visitAddress"></div>
        <div class="pill" id="visitWindow"></div>
      </div>
      <hr class="sep" />
      <div class="row">
        <div><label>Started at</label><input id="fldStartedAt" class="input" type="text" readonly /></div>
        <div><label>Stopped at</label><input id="fldStoppedAt" class="input" type="text" readonly /></div>
        <div><label>Duration (mm:ss)</label><input id="fldDuration"  class="input" type="text" readonly /></div>
      </div>
      <div class="row">
        <div><label>Start location</label><input id="fldGeoStart" class="input" type="text" readonly /></div>
        <div><label>Stop location</label><input id="fldGeoStop" class="input" type="text" readonly /></div>
      </div>
      <hr class="sep" />
      <div id="dynamicForm"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn"   type="button" onclick="App.saveDraft()">Save draft</button>
        <button class="btn ok" type="button" onclick="App.submitForm()">Submit to Admin</button>
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="viewAdmin" class="hidden">
    <div class="card">
      <div class="section-title">
        <h3>Admin Dashboard</h3>
        <div class="row" style="gap:8px">
          <button class="btn small"  type="button" onclick="App.admin.loadAll()">Refresh</button>
          <button class="btn danger small" type="button" onclick="App.admin.factoryReset?.()">Factory Reset</button>
        </div>
      </div>

      <!-- Panels comutabile -->
      <div class="grid">

        <!-- Shoppers -->
        <div id="panelShoppers" class="card">
          <div class="section-title">
            <h3>Shoppers</h3>
            <div class="row" style="gap:8px">
              <input id="imp_users" type="file" accept=".csv" class="hidden" />
              <button class="btn small" type="button" onclick="document.getElementById('imp_users').click()">Import CSV</button>
              <button class="btn small" type="button" onclick="App.admin.exportCSV('users')">Export CSV</button>
              <button class="btn ok small" type="button" onclick="App.admin.openNewShopper()">Add</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tblShoppers"><thead><tr><th>Name</th><th>Email</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Forms (list) -->
        <div id="panelForms" class="card hidden">
          <div class="section-title">
            <h3>Forms</h3>
            <div class="row" style="gap:8px">
              <input id="imp_forms" type="file" accept=".csv" class="hidden" />
              <button class="btn small" type="button" onclick="document.getElementById('imp_forms').click()">Import CSV</button>
              <button class="btn small" type="button" onclick="App.admin.exportCSV('forms')">Export CSV</button>
              <button class="btn ok small" type="button" onclick="App.admin.openFormBuilder(null)">Add</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tblForms"><thead><tr><th>Title</th><th>Sections</th><th>Fields</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Stores -->
        <div id="panelStores" class="card hidden">
          <div class="section-title">
            <h3>Stores</h3>
            <div class="row" style="gap:8px">
              <input id="imp_stores" type="file" accept=".csv" class="hidden" />
              <button class="btn small" type="button" onclick="document.getElementById('imp_stores').click()">Import CSV</button>
              <button class="btn small" type="button" onclick="App.admin.exportCSV('stores')">Export CSV</button>
              <button class="btn ok small" type="button" onclick="App.admin.openNewStore()">Add</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tblStores"><thead><tr><th>Name</th><th>City</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Assignments -->
        <div id="panelAssignments" class="card hidden">
          <div class="section-title">
            <h3>Assignments</h3>
            <div class="row" style="gap:8px">
              <input id="imp_assignments" type="file" accept=".csv" class="hidden" />
              <button class="btn small" type="button" onclick="document.getElementById('imp_assignments').click()">Import CSV</button>
              <button class="btn small" type="button" onclick="App.admin.exportCSV('assignments')">Export CSV</button>
              <button class="btn ok small" type="button" onclick="App.admin.openAssignment()">New assignment</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tblAssign"><thead><tr><th>Shopper</th><th>Store</th><th>Form</th><th>Window</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Submissions -->
        <div id="panelSubmissions" class="card hidden">
          <div class="section-title">
            <h3>Submissions</h3>
            <div class="row" style="gap:8px">
              <input id="imp_submissions" type="file" accept=".csv" class="hidden" />
              <button class="btn small" type="button" onclick="document.getElementById('imp_submissions').click()">Import CSV</button>
              <button class="btn small" type="button" onclick="App.admin.exportCSV('submissions')">Export CSV</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tblSubm"><thead><tr><th>Visit</th><th>Shopper</th><th>Duration</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- TIMER -->
<div id="timerOverlay">
  <div class="timer-box">
    <div class="sub">Visit in progress</div>
    <div class="timer-digits" id="timerDigits">00:00</div>
    <div class="timer-meta" id="timerMeta">Started now</div>
    <div class="row"><button class="btn warn block" type="button" onclick="App.timer.stop()">Stop & unlock form</button></div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authModal" class="modal">
  <div class="modal-card">
    <div class="section-title">
      <h3>Sign in</h3>
      <div class="row" style="gap:8px">
        <button class="btn small" type="button" onclick="App.ui.hideAuth()">Close</button>
      </div>
    </div>
    <div class="row">
      <div><label>Email / Username</label><input id="loginUser" class="input" placeholder="you@domain.com" /></div>
      <div><label>Password</label><input id="loginPass" type="password" class="input" placeholder="••••••••" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" type="button" onclick="App.auth.login()">Login</button>
      <button class="btn" type="button" onclick="App.auth.toggleRegister(true)">Create account</button>
    </div>
    <hr class="sep" />
    <div id="registerBox" class="hidden">
      <div class="row">
        <div><label>Full name</label><input id="regName" class="input" placeholder="Your name" /></div>
        <div><label>Email</label><input id="regEmail" class="input" placeholder="you@domain.com" /></div>
      </div>
      <div class="row">
        <div><label>Password</label><input id="regPass1" type="password" class="input" /></div>
        <div><label>Confirm</label><input id="regPass2" type="password" class="input" /></div>
      </div>
      <div class="sub">Account will be created as <b>Shopper</b> with status <b>Pending</b>. Admin approval required.</div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" type="button" onclick="App.auth.register()">Register</button>
        <button class="btn" type="button" onclick="App.auth.toggleRegister(false)">Cancel</button>
      </div>
    </div>
    <div id="seedInfo" class="sub" style="margin-top:10px">User your credentials for login or create new account.</div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal">
  <div class="modal-card">
    <div class="section-title">
      <h3>My Profile</h3>
      <div class="row" style="gap:8px">
        <button class="btn ok small" type="button" onclick="App.profile.save()">Save</button>
        <button class="btn small" type="button" onclick="App.ui.closeModal('profileModal')">Close</button>
      </div>
    </div>
    <div class="row">
      <div><label>Name</label><input id="pfName" class="input" /></div>
      <div><label>Email</label><input id="pfEmail" class="input" /></div>
    </div>
    <hr class="sep" />
    <div class="row">
      <div><label>Current password</label><input id="pfCurPass" type="password" class="input" placeholder="required to change password" /></div>
      <div><label>New password</label><input id="pfNewPass1" type="password" class="input" /></div>
    </div>
    <div class="row">
      <div><label>Confirm new password</label><input id="pfNewPass2" type="password" class="input" /></div>
      <div><label>Role</label><input id="pfRole" class="input" readonly /></div>
    </div>
    <div class="sub">Leave password fields empty if you don't want to change it.</div>
  </div>
</div>

<!-- NEW / EDIT MODALS -->
<div id="modalUser" class="modal"><div class="modal-card">
  <div class="section-title"><h3 id="muTitle">New Shopper</h3><div class="row" style="gap:8px"><button class="btn ok small" onclick="App.admin.saveUser()">Save</button><button class="btn small" onclick="App.ui.closeModal('modalUser')">Close</button></div></div>
  <div class="row"><div><label>Name</label><input id="muName" class="input"></div><div><label>Email</label><input id="muEmail" class="input"></div></div>
  <div class="row"><div><label>Password</label><input id="muPass" type="password" class="input"></div><div><label>Role</label><select id="muRole" class="input"><option>Shopper</option><option>Admin</option></select></div></div>
  <div class="row"><div><label>Status</label><select id="muStatus" class="input"><option>pending</option><option>active</option><option>disabled</option></select></div><div></div></div>
</div></div>

<div id="modalStore" class="modal"><div class="modal-card">
  <div class="section-title"><h3 id="msTitle">New Store</h3><div class="row" style="gap:8px"><button class="btn ok small" onclick="App.admin.saveStore()">Save</button><button class="btn small" onclick="App.ui.closeModal('modalStore')">Close</button></div></div>
  <input type="hidden" id="msId"/>
  <div class="row"><div><label>Name</label><input id="msName" class="input"></div><div><label>City</label><input id="msCity" class="input"></div></div>
  <div class="row"><div><label>Address</label><input id="msAddress" class="input"></div><div><label>Notes</label><input id="msNotes" class="input"></div></div>
</div></div>

<div id="modalAssign" class="modal"><div class="modal-card">
  <div class="section-title"><h3>New Assignment</h3><div class="row" style="gap:8px"><button class="btn ok small" onclick="App.admin.saveAssignment()">Save</button><button class="btn small" onclick="App.ui.closeModal('modalAssign')">Close</button></div></div>
  <div class="row"><div><label>Shopper</label><select id="maShopper" class="input"></select></div><div><label>Store</label><select id="maStore" class="input"></select></div></div>
  <div class="row"><div><label>Form</label><select id="maForm" class="input"></select></div><div><label>Status</label><select id="maStatus" class="input"><option>assigned</option><option>draft</option></select></div></div>
  <div class="row"><div><label>Window from</label><input id="maFrom" type="datetime-local" class="input"></div><div><label>Window to</label><input id="maTo" type="datetime-local" class="input"></div></div>
</div></div>

<!-- FORM BUILDER MODAL -->
<div id="formBuilderModal" class="modal">
  <div class="modal-card">
    <div class="section-title">
      <h3 id="fbHeading">Form Builder</h3>
      <div class="row" style="gap:8px">
        <button class="btn small" onclick="App.admin.addSection()">Add section</button>
        <button class="btn small" onclick="App.admin.addFieldUI()">Add field</button>
        <button class="btn ok small" onclick="App.admin.saveForm()">Save</button>
        <button class="btn small" onclick="App.ui.closeModal('formBuilderModal')">Close</button>
      </div>
    </div>
    <label>Form title</label>
    <input id="fbTitle" class="input" placeholder="e.g., Retail Visit v1" />
    <hr class="sep" />
    <div id="fbSections"></div>
    <hr class="sep" />
    <div id="fbFields"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============== API ============== */
const API = {
  base: 'https://backend.wedaevents.com/ms-api.php',
  token: localStorage.getItem('ms_token') || null,
  async call(q, method='GET', body=null, asText=false){
    const opt={ method, headers:{'Content-Type':'application/json'} };
    if(this.token) opt.headers['Authorization']='Bearer '+this.token;
    if(body) opt.body=JSON.stringify(body);
    const r=await fetch(this.base+'?q='+encodeURIComponent(q), opt);
    if(asText) return r.text();
    const j=await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if(!r.ok||j.ok===false) throw new Error(j.error||('HTTP '+r.status));
    return j;
  },
  async callText(q){ // for CSV export
    const r=await fetch(this.base+'?q='+encodeURIComponent(q), {headers:{ ...(this.token?{'Authorization':'Bearer '+this.token}:{}) }});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.text();
  },
  setToken(t){ this.token=t; localStorage.setItem('ms_token',t); },
  clearToken(){ this.token=null; localStorage.removeItem('ms_token'); }
};

/* ============== Utils ============== */
const U = {
  uid:()=>('id_'+Math.random().toString(36).slice(2)+Date.now().toString(36)),
  fmtDT(ts){ if(!ts) return ''; const n=parseInt(ts,10); return isNaN(n)?'':new Date(n).toLocaleString(); },
  pad:n=>(n<10?'0':'')+n,
  fmtDuration(sec){ sec=Math.max(0,Math.floor(sec||0)); const m=Math.floor(sec/60), s=sec%60; return U.pad(m)+':'+U.pad(s) },
  toast(msg,ms=2200){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms) },
  download(name, text, mime='text/csv;charset=utf-8'){ const blob=new Blob([text],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
};

/* ============== App ============== */
const App = {
  state:{ me:null, role:'Guest', timer:{running:false,start:0,interval:null}, curAssign:null, curForm:null, curSubmission:null },
  cache:{ users:[], stores:[], forms:[], assignments:[], submissions:[] },

  async init(){
    this.bindUI();
    this.bindCSVInputs();
    await this.tryBootstrap();
  },
  async tryBootstrap(){
    try{
      const boot=await API.call('bootstrap','GET');
      this.ingest(boot);
      this.ui.showView(this.state.me?.role==='Admin'?'admin':'shopper');
      this.admin.loadAll();
      this.refreshTasks();
    }catch(e){
      this.ui.updateAuthTabs(); 
      this.ui.showAuth(true);
    }
  },
  ingest(boot){
    this.state.me=boot.me; this.ui.updateAuthTabs(); this.ui.setRole(this.state.me?.role||'Guest');
    this.cache={ users:boot.users||[], stores:boot.stores||[], forms:boot.forms||[], assignments:boot.assignments||[], submissions:boot.submissions||[] };
    document.getElementById('adminNav').classList.toggle('hidden', !(this.state.me && this.state.me.role==='Admin'));
    this.admin.renderFormsList();
  },
  async softRefresh(){
    try{
      const boot=await API.call('bootstrap','GET');
      const oldSub=this.state.curSubmission?.id;
      this.ingest(boot);
      this.admin.loadAll();
      this.refreshTasks();
      if(oldSub){
        const s=this.cache.submissions.find(x=>x.id===oldSub);
        if(s){
          this.state.curSubmission=s;
          document.getElementById('fldStartedAt').value=s.started_at?U.fmtDT(s.started_at):'';
          document.getElementById('fldStoppedAt').value=s.stopped_at?U.fmtDT(s.stopped_at):'';
          document.getElementById('fldDuration').value=s.duration_sec?U.fmtDuration(s.duration_sec):'';
          document.getElementById('fldGeoStart').value=s.geo_start||'';
          document.getElementById('fldGeoStop').value=s.geo_stop||'';
        }
      }
    }catch(_){/* ignore */}
  },

  bindUI(){
    const $=sel=>document.querySelector(sel);
    $('#tabShopper').onclick = ()=>this.ui.showView('shopper');
    $('#tabAdmin').onclick   = ()=>this.ui.showView('admin');
    $('#tabAuth').onclick    = ()=>this.ui.showAuth(true);
    $('#tabProfile').onclick = ()=>this.profile.open();
    $('#tabLogout').onclick  = ()=>this.auth.logout();
  },
  bindCSVInputs(){
    const attach=(id,table)=>{ const inp=document.getElementById(id); if(!inp) return; inp.onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{ await API.call('csv/import','POST',{table,csv:txt}); U.toast('Imported: '+table); await App.softRefresh(); }catch(err){ U.toast(err.message) } finally{ inp.value=''; } }; };
    attach('imp_users','users'); attach('imp_forms','forms'); attach('imp_stores','stores'); attach('imp_assignments','assignments'); attach('imp_submissions','submissions');
  },

  ui:{
    showView(which){
      if(which==='admin' && (!App.state.me || App.state.me.role!=='Admin')){ U.toast('Admins only'); which='shopper'; }
      const s=id=>document.getElementById(id);
      s('viewShopper').classList.toggle('hidden', which!=='shopper');
      s('viewAdmin').classList.toggle('hidden', which!=='admin');
      document.getElementById('tabShopper').classList.toggle('active', which==='shopper');
      document.getElementById('tabAdmin').classList.toggle('active', which==='admin');
      const showAdminNav = (which==='admin') && (App.state.me && App.state.me.role==='Admin');
      document.getElementById('adminNav').classList.toggle('hidden', !showAdminNav);
    },
    setRole(r){
      App.state.role=r||'Guest';
      const b=document.getElementById('roleBadge'); b.textContent=r||'Guest';
    },
    updateAuthTabs(){
      const me=App.state.me;
      const on=(id,flag)=>document.getElementById(id).classList.toggle('hidden',!flag);
      on('tabAuth',!me); on('tabProfile',!!me); on('tabLogout',!!me);
      const a=document.getElementById('tabAdmin');
      a.classList.toggle('hidden',!(me&&me.role==='Admin')); a.toggleAttribute('disabled',!(me&&me.role==='Admin'));
    },
    showAuth(open=true){ document.getElementById('authModal').style.display=open?'flex':'none'; },
    hideAuth(){ this.showAuth(false); },
    openModal(id){ document.getElementById(id).style.display='flex'; },
    closeModal(id){ document.getElementById(id).style.display='none'; }
  },

  /* ===== Auth ===== */
  auth:{
    async login(){
      const user=document.getElementById('loginUser').value.trim();
      const pass=document.getElementById('loginPass').value;
      if(!user||!pass) return U.toast('Complete credentials');
      try{
        const j=await API.call('auth/login','POST',{user,pass});
        API.setToken(j.token); App.state.me=j.user;
        App.ui.hideAuth(); await App.softRefresh(); U.toast('Logged in');
        App.ui.showView(App.state.me.role==='Admin'?'admin':'shopper');
      }catch(e){ U.toast(e.message); }
    },
    toggleRegister(on){ document.getElementById('registerBox').classList.toggle('hidden', !on); },
    async register(){
      const name=document.getElementById('regName').value.trim();
      const email=document.getElementById('regEmail').value.trim();
      const pass1=document.getElementById('regPass1').value, pass2=document.getElementById('regPass2').value;
      if(!name||!email||!pass1||pass1!==pass2) return U.toast('Complete form correctly');
      try{
        await API.call('auth/register','POST',{name,email,pass:pass1});
        U.toast('Account created. Await admin approval.');
        App.auth.toggleRegister(false);
      }catch(e){ U.toast(e.message); }
    },
    async logout(){
      API.clearToken(); App.state.me=null; App.ui.updateAuthTabs(); App.ui.showView('shopper'); U.toast('Logged out');
      App.ui.showAuth(true);
    }
  },

  /* ===== Profile ===== */
  profile:{
    open(){ if(!App.state.me) return U.toast('Login first');
      document.getElementById('pfName').value=App.state.me.name||'';
      document.getElementById('pfEmail').value=App.state.me.email||'';
      document.getElementById('pfRole').value=App.state.me.role||'';
      document.getElementById('pfCurPass').value=''; document.getElementById('pfNewPass1').value=''; document.getElementById('pfNewPass2').value='';
      App.ui.openModal('profileModal');
    },
    async save(){
      const name=document.getElementById('pfName').value.trim();
      const email=document.getElementById('pfEmail').value.trim();
      const cur=document.getElementById('pfCurPass').value;
      const n1=document.getElementById('pfNewPass1').value, n2=document.getElementById('pfNewPass2').value;
      if(n1||n2){ if(n1!==n2) return U.toast('Passwords mismatch'); }
      try{
        await API.call('me/update','PATCH',{name,email,curPass:cur,newPass:n1||''});
        await App.softRefresh(); App.ui.closeModal('profileModal'); U.toast('Profile updated');
      }catch(e){ U.toast(e.message); }
    }
  },

  /* ===== Shopper view ===== */
  refreshTasks(){
    const me=App.state.me; const tbody=document.querySelector('#tasksTable tbody'); tbody.innerHTML='';
    const tasks=(App.cache.assignments||[]).filter(a=>me && a.shopper_id===me.id).sort((a,b)=>(a.window_from||0)-(b.window_from||0));
    document.getElementById('tasksEmpty').classList.toggle('hidden', !!tasks.length);
    tasks.forEach(a=>{
      const store=App.cache.stores.find(s=>s.id===a.store_id); const form=App.cache.forms.find(f=>f.id===a.form_id);
      const sub=App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);
      const status=sub?(sub.status||'submitted'):(a.status||'assigned');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${store?store.name:''} — <span class="sub">${form?form.title:''}</span></td>
        <td>${(a.window_from?U.fmtDT(a.window_from):'') + (a.window_to?' – '+U.fmtDT(a.window_to):'')}</td>
        <td>${status}</td>
        <td><button type="button" class="btn small" onclick="event.stopPropagation(); App.openAssignment('${a.id}')">Open</button></td>`;
      tbody.appendChild(tr);
    });
  },

  async openAssignment(assignId){
    const a=App.cache.assignments.find(x=>x.id===assignId); if(!a) return;
    const store=App.cache.stores.find(s=>s.id===a.store_id)||{};
    const form =App.cache.forms.find(f=>f.id===a.form_id)||{fields:[],title:'Form'};
    let sub=App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);
    if(!sub){
      const r=await API.call('submissions/upsert','POST',{assignmentId:a.id,shopperId:a.shopper_id,storeId:a.store_id,formId:a.form_id});
      await this.softRefresh(); sub=this.cache.submissions.find(s=>s.id===r.id);
    }
    this.state.curAssign=a; this.state.curForm=form; this.state.curSubmission=sub;

    document.getElementById('visitCard').classList.remove('hidden');
    document.getElementById('visitTitle').textContent=`Visit — ${form.title}`;
    document.getElementById('visitStore').textContent=store.name||'';
    document.getElementById('visitAddress').textContent=store.address||'';
    document.getElementById('visitWindow').textContent=(a.window_from?U.fmtDT(a.window_from):'')+(a.window_to?' – '+U.fmtDT(a.window_to):'');

    document.getElementById('fldStartedAt').value=sub.started_at?U.fmtDT(sub.started_at):'';
    document.getElementById('fldStoppedAt').value=sub.stopped_at?U.fmtDT(sub.stopped_at):'';
    document.getElementById('fldDuration').value=sub.duration_sec?U.fmtDuration(sub.duration_sec):'';
    document.getElementById('fldGeoStart').value=sub.geo_start||'';
    document.getElementById('fldGeoStop').value=sub.geo_stop||'';

    const host=document.getElementById('dynamicForm'); host.innerHTML='';
    const sections=(form.sections&&form.sections.length)?[...form.sections].sort((a,b)=>(a.ord??0)-(b.ord??0)):[{id:null,title:null,fields:form.fields||[]}];

    const anyLinked=sections.some(s=>(s.fields||[]).length);
    let sectionsToRender=sections;
    if(!anyLinked && (form.fields||[]).length && sections.length){
      const firstId=sections[0].id;
      sectionsToRender=sections.map(s=>({...s, fields:(form.fields||[]).filter(f=>(f.sectionId||firstId)===s.id)}));
    }
    sectionsToRender.forEach(sec=>{
      if(sec.title){ const h=document.createElement('div'); h.className='form-section-title'; h.textContent=sec.title; host.appendChild(h); }
      const fieldsIn=sec.fields && sec.fields.length ? sec.fields : (form.fields||[]).filter(ff=>(ff.sectionId||null)===(sec.id||null));
      fieldsIn.forEach(f=>{
        const wrap=document.createElement('div'); wrap.style.marginBottom='10px';
        wrap.innerHTML=`<label>${f.label}${f.required? ' <span class="sub">(required)</span>':''}</label>`;
        let el=null; const val=(sub.values||{})[f.id]??'';
        if(f.type==='textarea'){ el=document.createElement('textarea'); el.className='input'; el.rows=3; el.value=val; }
        else if(f.type==='number' || f.type==='rating'){ el=document.createElement('input'); el.className='input'; el.type='number'; el.value=val; if(f.type==='rating'){ el.min=1; el.max=5; el.step=1; el.placeholder='1-5' } }
        else if(f.type==='yesno'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option><option>Yes</option><option>No</option>'; el.value=val; }
        else if(f.type==='select'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option>'+ (f.options||[]).map(o=>`<option>${o}</option>`).join(''); el.value=val; }
        else { el=document.createElement('input'); el.className='input'; el.value=val; }
        let t=null; el.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>App.submission.saveField(f.id, el.value), 350); };
        wrap.appendChild(el); host.appendChild(wrap);
      });
    });
  },

  submission:{
    async saveField(fid,val){
      const s=App.state.curSubmission; if(!s) return;
      await API.call('submissions/update-values','PATCH',{id:s.id,patch:{[fid]:val}});
      const loc=App.cache.submissions.find(x=>x.id===s.id); if(loc){ loc.values=loc.values||{}; loc.values[fid]=val; }
    }
  },

  async saveDraft(){ const s=this.state.curSubmission; if(!s) return;
    await API.call('submissions/upsert','POST',{id:s.id,status:'draft'}); await this.softRefresh(); U.toast('Draft saved') },

  async submitForm(){ const s=this.state.curSubmission, f=this.state.curForm; if(!s||!f) return;
    if(!s.started_at||!s.stopped_at) return U.toast('Stop the timer before submitting');
    await API.call('submissions/upsert','POST',{id:s.id,status:'submitted',submittedAt:Date.now()});
    await this.softRefresh(); U.toast('Submitted') },

  /* ===== Timer ===== */
  timer:{
    async start(){
      const s=App.state.curSubmission; if(!s) return U.toast('Open a task first');
      if(s.started_at) return U.toast('Timer already started');
      let geo=null; if(navigator.geolocation){ try{ geo=await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r(p),_=>r(null))); }catch(_){ } }
      const started=Date.now();
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:started, geoStart: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null});
      App.state.timer.running=true; App.state.timer.start=started;
      document.getElementById('timerOverlay').style.display='flex';
      App.state.timer.interval=setInterval(()=>{
        const secs=(Date.now()-App.state.timer.start)/1000;
        document.getElementById('timerDigits').textContent=U.fmtDuration(secs);
        document.getElementById('timerMeta').textContent='Started at '+U.fmtDT(App.state.timer.start);
      },250);
      await App.softRefresh();
    },
    async stop(){
      const s=App.state.curSubmission; if(!s||!App.state.timer.running) return;
      let geo=null; if(navigator.geolocation){ try{ geo=await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r(p),_=>r(null))); }catch(_){ } }
      const stopped=Date.now(); const dur=Math.floor((stopped-App.state.timer.start)/1000);
      await API.call('submissions/upsert','POST',{id:s.id, stoppedAt:stopped, durationSec:dur, geoStop: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null });
      clearInterval(App.state.timer.interval); App.state.timer.running=false;
      document.getElementById('timerOverlay').style.display='none';
      await App.softRefresh(); U.toast('Timer stopped');
    },
    async reset(){
      const s=App.state.curSubmission; if(!s) return; if(App.state.timer.running) return U.toast('Stop timer first');
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:null, stoppedAt:null, durationSec:null, geoStart:'', geoStop:''});
      await App.softRefresh(); U.toast('Visit times cleared');
    }
  },

  /* ===== Admin ===== */
  admin:{
    selectedPanel:'shoppers',
    switchPanel(which){
      this.selectedPanel=which;
      ['Shoppers','Forms','Stores','Assignments','Submissions'].forEach(k=>{
        document.getElementById('nav'+k).classList.toggle('active', k.toLowerCase()===which);
      });
      const map={shoppers:'panelShoppers',forms:'panelForms',stores:'panelStores',assignments:'panelAssignments',submissions:'panelSubmissions'};
      Object.values(map).forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById(map[which]).classList.remove('hidden');
      if(which==='forms'){ this.renderFormsList(); }
      this.loadAll();
    },

    /* CSV handlers */
    async exportCSV(table){
      try{
        const csv=await API.callText('csv/export&table='+encodeURIComponent(table));
        U.download(table+'-'+new Date().toISOString().slice(0,10)+'.csv', csv);
      }catch(e){ U.toast(e.message); }
    },

    /* LOAD tables */
    loadAll(){
      // shoppers
      const ts=document.querySelector('#tblShoppers tbody'); if(ts){ ts.innerHTML='';
        (App.cache.users||[]).forEach(u=>{
          const info=document.createElement('tr');
          info.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.status} <span class="pill-inline">${u.role}</span></td>
            <td><button class="btn small" onclick="App.admin.editUser('${u.id}')">Edit</button>
                <button class="btn danger small" onclick="App.admin.deleteUser('${u.id}')">Delete</button></td>`;
          ts.appendChild(info);
          const actions=document.createElement('tr'); actions.className='user-actions';
          actions.innerHTML=`<td colspan="4"><div class="actions">
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','active')">Activate</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','pending')">Pending</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.userSetStatus('${u.id}','disabled')">Disable</button>
            </div><div class="divider"></div></td>`;
          ts.appendChild(actions);
        });
      }
      // stores
      const tstore=document.querySelector('#tblStores tbody'); if(tstore){ tstore.innerHTML='';
        (App.cache.stores||[]).forEach(s=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${s.name}</td><td>${s.city||''}</td>
            <td><button class="btn small" onclick="App.admin.editStore('${s.id}')">Edit</button>
                <button class="btn danger small" onclick="App.admin.deleteStore('${s.id}')">Delete</button></td>`;
          tstore.appendChild(tr);
        });
      }
      // assignments
      const ta=document.querySelector('#tblAssign tbody'); if(ta){ ta.innerHTML='';
        (App.cache.assignments||[]).forEach(a=>{
          const sh=App.cache.users.find(u=>u.id===a.shopper_id);
          const st=App.cache.stores.find(s=>s.id===a.store_id);
          const f =App.cache.forms.find(x=>x.id===a.form_id);
          const sub=App.cache.submissions.find(s=>s.assignment_id===a.id);
          const status=sub?(sub.status||'submitted'):(a.status||'assigned');
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${sh?sh.name:''}</td><td>${st?st.name:''}</td><td>${f?f.title:''}</td>
            <td>${(a.window_from?U.fmtDT(a.window_from):'') + (a.window_to?' – '+U.fmtDT(a.window_to):'')}</td>
            <td>${status}</td>
            <td>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.openAssignment('${a.id}')">Open</button>
              <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteAssignment('${a.id}')">Delete</button>
            </td>`;
          ta.appendChild(tr);
        });
      }

      // submissions
      const tsu=document.querySelector('#tblSubm tbody'); if(tsu){ tsu.innerHTML='';
        (App.cache.submissions||[]).forEach(s=>{
          const st=App.cache.stores.find(o=>o.id===s.store_id)||{}; const sh=App.cache.users.find(o=>o.id===s.shopper_id)||{};
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${st.name||''}</td><td>${sh.name||''}</td><td>${s.duration_sec?U.fmtDuration(s.duration_sec):''}</td>
            <td>${s.status||''}</td>
            <td>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.viewSubmission('${s.id}')">View</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.markSubmission('${s.id}','approved')">Approve</button>
              <button type="button" class="btn small" onclick="event.stopPropagation(); App.admin.markSubmission('${s.id}','rejected')">Reject</button>
              <button type="button" class="btn danger small" onclick="event.stopPropagation(); App.admin.deleteSubmission('${s.id}')">Delete</button>
            </td>`;
          tsu.appendChild(tr);
        });
      }
      // update Forms table too
      App.admin.renderFormsList();
    },

    /* ===== USERS ===== */
    openNewShopper(){ // create
      const m=document.getElementById('modalUser'); m.dataset.id='';
      document.getElementById('muTitle').textContent='New Shopper';
      document.getElementById('muName').value='';
      document.getElementById('muEmail').value='';
      document.getElementById('muPass').value='';
      document.getElementById('muRole').value='Shopper';
      document.getElementById('muStatus').value='pending';
      App.ui.openModal('modalUser');
    },
    editUser(id){
      const u=App.cache.users.find(x=>x.id===id); if(!u) return;
      const m=document.getElementById('modalUser'); m.dataset.id=id;
      document.getElementById('muTitle').textContent='Edit User';
      document.getElementById('muName').value=u.name||'';
      document.getElementById('muEmail').value=u.email||'';
      document.getElementById('muPass').value='';
      document.getElementById('muRole').value=u.role||'Shopper';
      document.getElementById('muStatus').value=u.status||'active';
      App.ui.openModal('modalUser');
    },
    async saveUser(){
      const m=document.getElementById('modalUser'); const id=m.dataset.id||null;
      const name=document.getElementById('muName').value.trim();
      const email=document.getElementById('muEmail').value.trim();
      const pass=document.getElementById('muPass').value;
      const role=document.getElementById('muRole').value;
      const status=document.getElementById('muStatus').value;
      if(!name||!email||(!id && !pass)) return U.toast('Fill required fields');
      try{
        if(id) await API.call('users/update','PATCH',{id,name,email,role,status, ...(pass?{pass}:{} )});
        else   await API.call('users/create','POST',{name,email,pass,role,status});
        App.ui.closeModal('modalUser'); await App.softRefresh(); U.toast('User saved');
      }catch(e){ U.toast(e.message); }
    },
    async userSetStatus(id,status){ await API.call('users/update','PATCH',{id,status}); await App.softRefresh(); U.toast('User '+status) },
    async deleteUser(id){ if(!confirm('Delete user?')) return; await API.call('users/delete','DELETE',{id}); await App.softRefresh(); U.toast('User deleted') },

    /* ===== STORES ===== */
    openNewStore(){ document.getElementById('msTitle').textContent='New Store';
      document.getElementById('msId').value=''; document.getElementById('msName').value=''; document.getElementById('msCity').value=''; document.getElementById('msAddress').value=''; document.getElementById('msNotes').value='';
      App.ui.openModal('modalStore'); },
    editStore(id){ const s=App.cache.stores.find(x=>x.id===id); if(!s) return;
      document.getElementById('msTitle').textContent='Edit Store';
      document.getElementById('msId').value=s.id; document.getElementById('msName').value=s.name||''; document.getElementById('msCity').value=s.city||''; document.getElementById('msAddress').value=s.address||''; document.getElementById('msNotes').value=s.notes||''; App.ui.openModal('modalStore'); },
    async saveStore(){ const id=document.getElementById('msId').value||null; const name=document.getElementById('msName').value.trim(); if(!name) return U.toast('Name required');
      const city=document.getElementById('msCity').value.trim(), address=document.getElementById('msAddress').value.trim(), notes=document.getElementById('msNotes').value.trim();
      try{
        if(id) await API.call('stores/update','PATCH',{id,name,city,address,notes});
        else   await API.call('stores/create','POST',{name,city,address,notes});
        App.ui.closeModal('modalStore'); await App.softRefresh(); U.toast('Store saved');
      }catch(e){ U.toast(e.message); } },
    async deleteStore(id){ if(!confirm('Delete store?')) return; await API.call('stores/delete','DELETE',{id}); await App.softRefresh(); U.toast('Store deleted') },

    /* ===== ASSIGNMENTS ===== */
    openAssignment(id=null){
      const m=document.getElementById('modalAssign'); m.dataset.id=id||'';
      // fill selects
      const sel=(el,opts,val)=>{ el.innerHTML=opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join(''); if(val!=null) el.value=val; };
      sel(document.getElementById('maShopper'), (App.cache.users||[]).filter(u=>u.status==='active').map(u=>({value:u.id,label:`${u.name} (${u.email})`})));
      sel(document.getElementById('maStore'), (App.cache.stores||[]).map(s=>({value:s.id,label:s.name})));
      sel(document.getElementById('maForm'),  (App.cache.forms||[]).map(f=>({value:f.id,label:f.title})));
      document.getElementById('maStatus').value='assigned';
      document.getElementById('maFrom').value=''; document.getElementById('maTo').value='';
      if(id){ const a=App.cache.assignments.find(x=>x.id===id); if(a){
        document.getElementById('maShopper').value=a.shopper_id||''; document.getElementById('maStore').value=a.store_id||''; document.getElementById('maForm').value=a.form_id||'';
        document.getElementById('maStatus').value=a.status||'assigned';
        if(a.window_from) document.getElementById('maFrom').value=new Date(a.window_from).toISOString().slice(0,16);
        if(a.window_to)   document.getElementById('maTo').value=new Date(a.window_to).toISOString().slice(0,16);
      }}
      App.ui.openModal('modalAssign');
    },
	async saveAssignment(){
	  const m=document.getElementById('modalAssign'); const id=m.dataset.id||null;
	  const shopperId=document.getElementById('maShopper').value;
	  const storeId  =document.getElementById('maStore').value;
	  const formId   =document.getElementById('maForm').value;
	  const status   =document.getElementById('maStatus').value;
	  const fromRaw  =document.getElementById('maFrom').value;
	  const toRaw    =document.getElementById('maTo').value;

	  if(!shopperId||!storeId||!formId) return U.toast('Complete all fields');

	  const windowFrom = fromRaw ? new Date(fromRaw).getTime() : null;
	  const windowTo   = toRaw   ? new Date(toRaw).getTime()   : null;

	  // payload cu sinonime (ca să meargă indiferent cum e implementată ruta pe server)
	  const payload = {
		id, status,
		shopperId, storeId, formId, windowFrom, windowTo,
		// snake_case aliases (în caz că backendul le așteaptă așa)
		shopper_id: shopperId, store_id: storeId, form_id: formId,
		window_from: windowFrom, window_to: windowTo
	  };

	  // încercăm mai multe rute posibile până prinde una
	  const candidates = [
		'assignments/upsert',
		'assignments/save',
		'assignment/upsert',
		'assignment/save',
		'assignments/create'
	  ];

	  let lastErr=null, success=false;
	  for(const route of candidates){
		try{
		  await API.call(route, 'POST', payload);
		  success=true; break;
		}catch(e){
		  lastErr=e;
		  // dacă e altă eroare decât "Unknown route" / 404, nu mai încercăm
		  if(!/Unknown route|HTTP 404/i.test(e.message)){ throw e; }
		}
	  }
	  if(!success){ throw lastErr; }

	  App.ui.closeModal('modalAssign');
	  await App.softRefresh();
	  U.toast('Assignment saved');
	},
    async deleteAssignment(id){ if(!confirm('Delete assignment?')) return; await API.call('assignments/delete','DELETE',{id}); await App.softRefresh(); U.toast('Assignment deleted') },

    /* ===== FORMS LIST ===== */
    renderFormsList(){
      const tb=document.querySelector('#tblForms tbody'); if(!tb) return; tb.innerHTML='';
      (App.cache.forms||[]).forEach(f=>{
        const secCount=(f.sections||[]).length||0; const fldCount=(f.fields||[]).length||0;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${f.title}</td><td>${secCount}</td><td>${fldCount}</td>
        <td>
          <button class="btn small" onclick="App.admin.openFormBuilder('${f.id}')">Edit</button>
          <button class="btn danger small" onclick="App.admin.deleteForm('${f.id}')">Delete</button>
        </td>`;
        tb.appendChild(tr);
      });
    },
    async deleteForm(id){ if(!confirm('Delete form?')) return; await API.call('forms/delete','DELETE',{id}); await App.softRefresh(); U.toast('Form deleted') },

    /* ===== FORM BUILDER ===== */
    _editingFormId:null, _fbForm:{id:null,title:'',sections:[],fields:[]},

    openFormBuilder(id=null){
      this._editingFormId=id;
      if(id){
        const f=App.cache.forms.find(x=>x.id===id);
        const sections=(f.sections&&f.sections.length)?JSON.parse(JSON.stringify(f.sections)):[{id:U.uid(),title:'General',ord:0,fields:[]}];
        const fields=(f.fields||[]).map(x=>({...x}));
        fields.forEach(fd=>{ if(!fd.sectionId) fd.sectionId=sections[0].id; });
        this._fbForm={ id:f.id, title:f.title, sections, fields };
      }else{
        this._fbForm={ id:null, title:'', sections:[{id:U.uid(),title:'General',ord:0,fields:[]}], fields:[] };
      }
      document.getElementById('fbHeading').textContent = id?'Edit Form':'New Form';
      document.getElementById('fbTitle').value=this._fbForm.title||'';
      this.renderFBSections(); this.renderFBFields();
      App.ui.openModal('formBuilderModal');
    },
    renderFBSections(){
      const host=document.getElementById('fbSections'); host.innerHTML='';
      const form=this._fbForm;
      if(!form.sections.length){ host.innerHTML='<div class="sub">No sections yet. Click "Add section".</div>'; return; }
      form.sections.sort((a,b)=>(a.ord??0)-(b.ord??0)).forEach((s,idx)=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
        <div class="section-title"><h3>Section ${idx+1}</h3>
          <div class="row" style="gap:6px">
            <button type="button" class="btn small" onclick="App.admin.moveSection(${idx},-1)">↑</button>
            <button type="button" class="btn small" onclick="App.admin.moveSection(${idx},1)">↓</button>
            <button type="button" class="btn danger small" onclick="App.admin.delSection(${idx})">Delete</button>
          </div></div>
        <label>Title</label>
        <input class="input" value="${s.title||''}" oninput="App.admin.updateSectionTitle(${idx}, this.value)" />
        <div class="sub">ID: ${s.id}</div>`;
        host.appendChild(card);
      });
    },
    addSection(){ const f=this._fbForm; f.sections.push({id:U.uid(),title:'New section',ord:f.sections.length,fields:[]}); this.renderFBSections(); this.renderFBFields(); },
    moveSection(i,dir){ const a=this._fbForm.sections; const j=i+dir; if(j<0||j>=a.length) return; [a[i],a[j]]=[a[j],a[i]]; a.forEach((s,k)=>s.ord=k); this.renderFBSections(); this.renderFBFields(); },
    delSection(i){ const f=this._fbForm; if(f.sections.length===1) return U.toast('At least one section'); const rem=f.sections.splice(i,1)[0]; f.fields.forEach(fd=>{ if(fd.sectionId===rem.id) fd.sectionId=f.sections[0].id }); f.sections.forEach((s,k)=>s.ord=k); this.renderFBSections(); this.renderFBFields(); },
    updateSectionTitle(i,v){ this._fbForm.sections[i].title=v },

    renderFBFields(){
      const host=document.getElementById('fbFields'); host.innerHTML='';
      const form=this._fbForm;
      if(!form.fields.length){ host.innerHTML='<div class="sub">No fields yet. Click "Add field".</div>'; return; }
      const sectionOptions=form.sections.sort((a,b)=>(a.ord??0)-(b.ord??0)).map(s=>`<option value="${s.id}">${s.title}</option>`).join('');
      form.fields.forEach((f,idx)=>{
        const box=document.createElement('div'); box.className='card';
        box.innerHTML=`
          <div class="section-title"><h3>Field ${idx+1}</h3>
            <div class="row" style="gap:6px">
              <button type="button" class="btn small" onclick="App.admin.moveField(${idx},-1)">↑</button>
              <button type="button" class="btn small" onclick="App.admin.moveField(${idx},1)">↓</button>
              <button type="button" class="btn danger small" onclick="App.admin.delField(${idx})">Delete</button>
            </div></div>
          <div class="row">
            <div><label>Label</label><input class="input" value="${f.label||''}" oninput="App.admin.updateField(${idx},'label',this.value)"/></div>
            <div><label>Type</label>
              <select class="input" onchange="App.admin.updateField(${idx},'type',this.value)">
                ${['text','textarea','number','yesno','select','rating'].map(t=>`<option ${f.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div><label>Required</label>
              <select class="input" onchange="App.admin.updateField(${idx},'required',this.value==='true')">
                <option value="false" ${!f.required?'selected':''}>No</option>
                <option value="true"  ${f.required?'selected':''}>Yes</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>Section</label><select class="input" onchange="App.admin.updateField(${idx},'sectionId',this.value)">${sectionOptions}</select></div>
            <div ${f.type==='select'?'':'class="hidden"'} id="opt_${idx}">
              <label>Options (comma separated)</label>
              <input class="input" value="${(f.options||[]).join(', ')}" oninput="App.admin.updateOptions(${idx}, this.value)"/>
            </div>
          </div>
          <div class="sub">ID: ${f.id}</div>`;
        host.appendChild(box);
        const sel=box.querySelector('select.input[onchange*="sectionId"]'); if(sel) sel.value=f.sectionId || (form.sections[0]&&form.sections[0].id);
      });
    },
    addFieldUI(){ const d=this._fbForm.sections[0]?.id || U.uid(); if(!this._fbForm.sections.length){ this._fbForm.sections.push({id:d,title:'General',ord:0,fields:[]}) } this._fbForm.fields.push({id:U.uid(),label:'New field',type:'text',required:false,options:[],sectionId:d}); this.renderFBFields(); },
    moveField(i,dir){ const a=this._fbForm.fields; const j=i+dir; if(j<0||j>=a.length) return; [a[i],a[j]]=[a[j],a[i]]; this.renderFBFields(); },
    delField(i){ this._fbForm.fields.splice(i,1); this.renderFBFields(); },
    updateField(i,k,v){ this._fbForm.fields[i][k]=v; if(k==='type') setTimeout(()=>this.renderFBFields(),0) },
    updateOptions(i,raw){ this._fbForm.fields[i].options=raw.split(',').map(s=>s.trim()).filter(Boolean) },
    async saveForm(){
      const title=document.getElementById('fbTitle').value.trim(); if(!title) return U.toast('Title required');
      const f=this._fbForm; f.sections.forEach((s,idx)=>s.ord=idx);
      const payload={ id:f.id||null, title, sections:f.sections.map(s=>({id:s.id,title:s.title,ord:s.ord})),
        fields:f.fields.map((fd,idx)=>({id:fd.id,label:fd.label,type:fd.type,required:!!fd.required,options:fd.options||[],sectionId:fd.sectionId||f.sections[0].id,ord:idx})) };
      await API.call('forms/save','POST',payload); await App.softRefresh(); App.ui.closeModal('formBuilderModal'); U.toast('Form saved');
    },

    /* ===== SUBMISSIONS ACTIONS ===== */
    async markSubmission(id,state){ await API.call('submissions/mark','PATCH',{id,status:state}); await App.softRefresh(); U.toast('Submission '+state) },
    async deleteSubmission(id){ if(!confirm('Delete submission?')) return; await API.call('submissions/delete','DELETE',{id}); await App.softRefresh(); U.toast('Submission deleted') },

    /* printable view */
	viewSubmission(id){
	  const s = App.cache.submissions.find(x=>x.id===id); if(!s) return U.toast('Missing');
	  const st = App.cache.stores.find(o=>o.id===s.store_id)||{};
	  const f  = App.cache.forms.find(o=>o.id===s.form_id)||{fields:[],title:'Form'};
	  const sh = App.cache.users.find(o=>o.id===s.shopper_id)||{};

	  const esc=v=>(v==null?'':String(v).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])));
	  const nl2br=v=>esc(v).replace(/\n/g,'<br>');
	  const star=n=>{
		const v=Math.max(1,Math.min(5,parseInt(n||0,10)||0));
		return `<span style="font-size:16px">${'★'.repeat(v)}${'☆'.repeat(5-v)}</span><span style="margin-left:6px;font-size:12px;color:#666">${v}/5</span>`;
	  };
	  const valueFor=(fld,val)=> val==null||val===''
		? '<span style="color:#999">–</span>'
		: (fld.type==='textarea' ? nl2br(val) : (fld.type==='rating' ? star(val) : esc(val)));

	  // ---------- build rows grouped pe sections ----------
	  const fields = f.fields||[];
	  const sections = (f.sections||[]).slice().sort((a,b)=>(a.ord??0)-(b.ord??0));
	  const bySectionId = (secId)=> fields.filter(fd => (fd.sectionId||null) === (secId||null));

	  let rows = '';

	  if (sections.length){
		sections.forEach(sec=>{
		  const inSec = bySectionId(sec.id);
		  if (!inSec.length) return; // sari secțiuni goale
		  rows += `<tr class="sec"><th colspan="2">${esc(sec.title||'Section')}</th></tr>`;
		  inSec.forEach(fl=>{
			rows += `<tr><th>${esc(fl.label)}</th><td>${valueFor(fl,(s.values||{})[fl.id])}</td></tr>`;
		  });
		});
		// câmpuri rămase fără section => "Other"
		const secIds=new Set(sections.map(x=>x.id));
		const other = fields.filter(fd=>!secIds.has(fd.sectionId));
		if(other.length){
		  rows += `<tr class="sec"><th colspan="2">Other</th></tr>`;
		  other.forEach(fl=>{
			rows += `<tr><th>${esc(fl.label)}</th><td>${valueFor(fl,(s.values||{})[fl.id])}</td></tr>`;
		  });
		}
	  } else {
		// fallback – fără sections
		rows = fields.map(fl=>`<tr><th>${esc(fl.label)}</th><td>${valueFor(fl,(s.values||{})[fl.id])}</td></tr>`).join('');
		if(!rows) rows = `<tr><td colspan="2" style="color:#777;padding:12px 0">No fields</td></tr>`;
	  }

	  const doc=window.open('','_blank');
	  doc.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Submission ${esc(s.id)}</title>
	<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
	:root{--ink:#111;--muted:#6b7280;--paper:#FAFAFC;--line:#e5e7eb;--card:#fff}
	*{box-sizing:border-box}html,body{margin:0;background:var(--paper);color:var(--ink);font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}
	.container{max-width:900px;margin:0 auto;padding:28px 20px 60px}
	.doc{background:var(--card);border:1px solid var(--line);border-radius:14px}
	.head{padding:22px 22px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}
	.logo{width:34px;height:34px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:700}
	.chips{display:flex;gap:8px;flex-wrap:wrap}.chip{padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#374151;background:#fff}
	.meta{padding:14px 22px 8px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
	@media(max-width:800px){.meta{grid-template-columns:1fr}}
	.toolbar{padding:10px 22px;display:flex;gap:8px;border-bottom:1px solid var(--line)}
	.btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:13px}
	.btn.primary{background:#111;color:#fff;border-color:#111}
	.content{padding:16px 22px 26px}
	table{width:100%;border-collapse:collapse}th,td{text-align:left;vertical-align:top;padding:10px 8px;border-bottom:1px solid var(--line)}
	th{width:28%;color:#374151;font-weight:600}
	tr.sec th{background:#f3f4f6;border-bottom-color:#e5e7eb;color:#374151;text-transform:uppercase;letter-spacing:.04em;font-size:11px;padding-top:14px}
	.foot{padding:14px 22px;border-top:1px solid var(--line);color:#6b7280;font-size:12px}
	@media print{.toolbar{display:none}body{background:#fff}.doc{box-shadow:none}}
	</style></head><body>
	<div class="container"><div class="doc">
	  <div class="head">
		<div style="display:flex;gap:10px;align-items:center">
		  <div class="logo">MS</div>
		  <div>
			<h1 style="font-size:18px;margin:0">Submission <span style="color:#6b7280">#${esc(s.id)}</span></h1>
			<div class="chips">
			  <span class="chip"><b>Form:</b> ${esc(f.title)}</span>
			  <span class="chip"><b>Store:</b> ${esc(st.name||'')}</span>
			  <span class="chip"><b>Shopper:</b> ${esc(sh.name||'')}</span>
			  <span class="chip">${esc(s.status||'')}</span>
			</div>
		  </div>
		</div>
		<div style="color:#6b7280">Generated: ${esc(new Date().toLocaleString())}</div>
	  </div>

	  <div class="meta">
		<div><b>Started:</b> ${esc(U.fmtDT(s.started_at))}</div>
		<div><b>Stopped:</b> ${esc(U.fmtDT(s.stopped_at))}</div>
		<div><b>Duration:</b> ${esc(U.fmtDuration(s.duration_sec||0))}</div>
		<div><b>Geo:</b> ${esc(s.geo_start||'–')} → ${esc(s.geo_stop||'–')}</div>
	  </div>

	  <div class="toolbar">
		<button class="btn primary" onclick="window.print()">Print</button>
		<button class="btn" onclick="window.close()">Close</button>
	  </div>

	  <div class="content">
		<table>${rows}</table>
	  </div>

	  <div class="foot">Stored in MySQL (live API).</div>
	</div></div>
	<script>(function(){})();<\/script>
	</body></html>`);
	  doc.document.close();
	},

    /* ===== MISC ===== */
    async factoryReset(){ if(!confirm('Erase ALL data?')) return; await API.call('factory/reset','POST'); await App.softRefresh(); U.toast('Factory reset complete') }
  }
};

window.addEventListener('load', ()=>App.init());
</script>
</body>
</html>
