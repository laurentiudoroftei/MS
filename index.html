<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover"
/>
<title>Mystery Shopper â€“ Standalone</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#1d1d1f; --panel:#1a1a21; --panel2:#17171c;
  --text:#ececec; --muted:#b9b9c2; --hint:#9a9aa3;
  --accent1:#7325C5; --accent2:#FF6200; --accent3:#F43C6E;
  --glass:rgba(255,255,255,0.06); --border:rgba(255,255,255,0.12);
  --ok:#2ecc71; --warn:#f1c40f; --danger:#ff4d4d;
  --radius:16px; --rsm:12px; --pad:14px; --padlg:20px;
}

/* Base / layout */
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial
}
/* Hide scrollbars (still scrollable) */
body{ overflow-y:auto; -ms-overflow-style:none; scrollbar-width:none; touch-action:pan-x pan-y; overscroll-behavior-y:none; }
body::-webkit-scrollbar{ width:0; height:0 }

/* Links & buttons */
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}

/* Container spacing more airy */
.wrapper{max-width:1200px;margin:0 auto;padding:20px}
.wrapper > section{ margin-bottom:28px; }

/* Header */
.header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(29,29,31,.96), rgba(29,29,31,.86));backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.header-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);font-size:12px;color:var(--muted)}
.title{font-weight:700;letter-spacing:.3px}
.tabs{display:flex;gap:10px;flex-wrap:wrap}
.tab{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:999px;color:var(--muted)}
.tab[disabled]{opacity:.5;pointer-events:none}
.tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white;border-color:transparent}

/* Controls */
.btn{background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;color:inherit}
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent3));border:none;color:#fff}
.btn.ok{background:var(--ok);border:none;color:#111}
.btn.warn{background:var(--warn);border:none;color:#111}
.btn.danger{background:var(--danger);border:none;color:#fff}
.btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
.btn.block{display:block;width:100%}

/* Grid (shopper view) */
.grid{display:grid;gap:20px}
.grid.two{grid-template-columns:1fr 1fr}
@media(max-width:960px){.grid.two{grid-template-columns:1fr}}

/* Cards */
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:22px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px}
.section-title h3{margin:0;font-size:18px}
.sub{font-size:12px;color:var(--hint)}
.kv{display:flex;gap:10px;flex-wrap:wrap}
.kv .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--glass)}

/* Inputs */
.input, select, textarea{width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;outline:none}
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 6px}
.row{display:flex;gap:12px}
.row>*{flex:1}
hr.sep{border:none;border-top:1px dashed var(--border);margin:14px 0}

/* Tables */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
.table th{color:var(--muted);font-weight:600}
.badge-ok{background:rgba(46,204,113,.15);color:#8ef5b7;border:1px solid rgba(46,204,113,.35)}
.badge-warn{background:rgba(241,196,15,.12);color:#ffe27a;border:1px solid rgba(241,196,15,.35)}
.badge-danger{background:rgba(255,77,77,.12);color:#ff9a9a;border:1px solid rgba(255,77,77,.35)}
.pill-inline{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}

/* Shopper actions row (horizontal buttons under user) */
.user-actions{ padding:8px 0 12px; }
.user-actions .actions{ display:flex; gap:8px; flex-wrap:wrap; }
.user-actions .divider{ margin-top:10px; border-top:1px dashed var(--border); }

/* ===== Admin SIDE MENU layout ===== */
.adminLayout{
  display:grid;
  grid-template-columns: 230px 1fr;
  gap:20px;
}
@media(max-width:960px){
  .adminLayout{ grid-template-columns:1fr; }
}
.adminMenu{
  position:sticky; top:72px;
  height:fit-content;
  padding:16px;
  border-radius:16px;
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
}
.adminMenu .mi{
  width:100%; text-align:left; padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:var(--panel); color:var(--muted); margin-bottom:10px;
}
.adminMenu .mi.active{ background:linear-gradient(90deg,var(--accent1),var(--accent3)); color:#fff; border-color:transparent }

/* Content panels spacing */
.adminContent .card{ margin:0 } /* full width panel */
.mt-lg{ margin-top:26px; }
.mt-xl{ margin-top:34px; }

/* Overlay timer */
#timerOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px) saturate(120%);
  display:none;align-items:center;justify-content:center;z-index:100;
}
.timer-box{
  width:min(520px,90vw);background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);border-radius:22px;padding:22px;text-align:center
}
.timer-digits{font-size:48px;font-weight:700;letter-spacing:2px;margin:6px 0 10px}
.timer-meta{font-size:13px;color:var(--muted);margin-bottom:14px}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:90}
.modal-card{width:min(680px,92vw);max-height:90vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:18px;padding:18px}

/* Toast */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;border:1px solid var(--border);
  border-radius:12px;padding:12px 16px;z-index:120;display:none
}

/* Select legibility when opened */
select:focus, select:active{ background:#fff; color:#111; }
option{ color:#111; background:#fff; }

/* Utils */
.hidden{display:none !important}
.faded{opacity:.6}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="badge">MS</div>
      <div class="title">Mystery Shopper Manager</div>
      <div id="roleBadge" class="pill-inline badge-warn">Guest</div>
    </div>
    <div class="tabs">
      <button id="tabShopper" class="tab active">Shopper</button>
      <button id="tabAdmin" class="tab">Admin</button>
      <button id="tabAuth" class="tab">Login</button>
      <button id="tabProfile" class="tab hidden">Profile</button>
      <button id="tabLogout" class="tab hidden">Logout</button>
    </div>
  </div>
</header>

<div class="wrapper">

  <!-- SHOPPER VIEW -->
  <section id="viewShopper" class="grid two">
    <div class="card">
      <div class="section-title">
        <h3>My Tasks</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn small" onclick="App.refreshTasks()">Refresh</button>
        </div>
      </div>
      <table class="table" id="tasksTable">
        <thead>
          <tr><th>Visit</th><th>When</th><th>Status</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="tasksEmpty" class="sub hidden">No tasks assigned yet.</div>
    </div>

    <div id="visitCard" class="card hidden">
      <div class="section-title">
        <h3 id="visitTitle">Visit</h3>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="btnStartVisit" class="btn primary small" onclick="App.timer.start()">Start timer</button>
          <button id="btnResetVisit" class="btn small" onclick="App.timer.reset()" title="Clear start/stop times">Reset</button>
        </div>
      </div>
      <div class="kv">
        <div class="pill" id="visitStore"></div>
        <div class="pill" id="visitAddress"></div>
        <div class="pill" id="visitWindow"></div>
      </div>
      <hr class="sep" />

      <div class="row">
        <div>
          <label>Started at</label>
          <input id="fldStartedAt" class="input" type="text" readonly />
        </div>
        <div>
          <label>Stopped at</label>
          <input id="fldStoppedAt" class="input" type="text" readonly />
        </div>
        <div>
          <label>Duration (mm:ss)</label>
          <input id="fldDuration" class="input" type="text" readonly />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Start location</label>
          <input id="fldGeoStart" class="input" type="text" readonly />
        </div>
        <div>
          <label>Stop location</label>
          <input id="fldGeoStop" class="input" type="text" readonly />
        </div>
      </div>

      <hr class="sep" />
      <div id="dynamicForm"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn" onclick="App.saveDraft()">Save draft</button>
        <button class="btn ok" onclick="App.submitForm()">Submit to Admin</button>
      </div>
    </div>
  </section>

  <!-- ADMIN VIEW -->
  <section id="viewAdmin" class="hidden">
    <div class="card">
      <div class="section-title">
        <h3>Admin Dashboard</h3>
        <div class="row" style="gap:8px">
          <button class="btn small" onclick="App.admin.loadAll()">Refresh</button>
          <button class="btn small" onclick="App.admin.backup()">Backup JSON</button>
          <button class="btn small" onclick="App.admin.restore()">Restore JSON</button>
          <button class="btn danger small" onclick="App.admin.factoryReset()">Factory Reset</button>
        </div>
      </div>

      <!-- Side menu + content -->
      <div class="adminLayout">
        <aside class="adminMenu">
          <button class="mi active" id="miShoppers" onclick="App.admin.switchPanel('shoppers')">Shoppers</button>
          <button class="mi" id="miForms" onclick="App.admin.switchPanel('forms')">Forms</button>
          <button class="mi" id="miStores" onclick="App.admin.switchPanel('stores')">Stores</button>
        </aside>

        <div class="adminContent">
          <!-- FORMS PANEL -->
          <div id="panelForms" class="card hidden">
            <div class="section-title"><h3>Forms</h3><button class="btn small" onclick="App.admin.openFormBuilder()">New</button></div>
            <table class="table" id="tblForms"><thead><tr><th>Title</th><th>Fields</th><th></th></tr></thead><tbody></tbody></table>
          </div>

          <!-- SHOPPERS PANEL -->
          <div id="panelShoppers" class="card">
            <div class="section-title"><h3>Shoppers</h3><button class="btn small" onclick="App.admin.openNewShopper()">Add</button></div>
            <table class="table" id="tblShoppers">
              <thead><tr><th>Name</th><th>Email</th><th>Status</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- STORES PANEL -->
          <div id="panelStores" class="card hidden">
            <div class="section-title"><h3>Stores</h3><button class="btn small" onclick="App.admin.openNewStore()">Add</button></div>
            <table class="table" id="tblStores"><thead><tr><th>Name</th><th>City</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <!-- Bottom sections - more spacing -->
      <div class="card mt-xl">
        <div class="section-title"><h3>Assignments</h3><button class="btn small" onclick="App.admin.openAssignment()">New assignment</button></div>
        <table class="table" id="tblAssign"><thead><tr><th>Shopper</th><th>Store</th><th>Form</th><th>Window</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card mt-lg">
        <div class="section-title"><h3>Submissions</h3><div class="row" style="gap:8px"><button class="btn small" onclick="App.admin.exportCSV()">Export CSV</button></div></div>
        <table class="table" id="tblSubm"><thead><tr><th>Visit</th><th>Shopper</th><th>Duration</th><th>Status</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

</div>

<!-- TIMER OVERLAY -->
<div id="timerOverlay">
  <div class="timer-box">
    <div class="sub">Visit in progress</div>
    <div class="timer-digits" id="timerDigits">00:00</div>
    <div class="timer-meta" id="timerMeta">Started now</div>
    <div class="row">
      <button class="btn warn block" onclick="App.timer.stop()">Stop & unlock form</button>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authModal" class="modal">
  <div class="modal-card">
    <div class="section-title"><h3>Sign in</h3><button class="btn small" onclick="App.ui.hideAuth()">Close</button></div>
    <div class="row">
      <div><label>Email / Username</label><input id="loginUser" class="input" placeholder="you@domain.com" /></div>
      <div><label>Password</label><input id="loginPass" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" onclick="App.auth.login()">Login</button>
      <button class="btn" onclick="App.auth.openRegister()">Create account</button>
    </div>
    <hr class="sep" />
    <!-- Register = always Shopper/Pending -->
    <div id="registerBox" class="hidden">
      <div class="row">
        <div><label>Full name</label><input id="regName" class="input" placeholder="Your name" /></div>
        <div><label>Email</label><input id="regEmail" class="input" placeholder="you@domain.com" /></div>
      </div>
      <div class="row">
        <div><label>Password</label><input id="regPass1" type="password" class="input" /></div>
        <div><label>Confirm</label><input id="regPass2" type="password" class="input" /></div>
      </div>
      <div class="sub">Account will be created as <b>Shopper</b> with status <b>Pending</b>. An admin must approve it.</div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" onclick="App.auth.register()">Register</button>
      </div>
    </div>
    <div id="seedInfo" class="sub" style="margin-top:10px"></div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal">
  <div class="modal-card">
    <div class="section-title">
      <h3>My Profile</h3>
      <div class="row" style="gap:8px">
        <button class="btn ok small" onclick="App.profile.save()">Save</button>
        <button class="btn small" onclick="App.ui.closeModal('profileModal')">Close</button>
      </div>
    </div>
    <div class="row">
      <div><label>Name</label><input id="pfName" class="input" /></div>
      <div><label>Email</label><input id="pfEmail" class="input" /></div>
    </div>
    <hr class="sep" />
    <div class="row">
      <div><label>Current password</label><input id="pfCurPass" type="password" class="input" placeholder="required to change password" /></div>
      <div><label>New password</label><input id="pfNewPass1" type="password" class="input" /></div>
    </div>
    <div class="row">
      <div><label>Confirm new password</label><input id="pfNewPass2" type="password" class="input" /></div>
      <div><label>Role</label><input id="pfRole" class="input" readonly /></div>
    </div>
    <div class="sub">Leave password fields empty if you don't want to change it.</div>
  </div>
</div>

<!-- FORM BUILDER MODAL -->
<div id="formModal" class="modal">
  <div class="modal-card">
    <div class="section-title">
      <h3 id="formModalTitle">Form Builder</h3>
      <div class="row" style="gap:8px">
        <button class="btn small" onclick="App.admin.addFieldUI()">Add field</button>
        <button class="btn ok small" onclick="App.admin.saveForm()">Save</button>
        <button class="btn small" onclick="App.ui.closeModal('formModal')">Close</button>
      </div>
    </div>
    <label>Form title</label>
    <input id="fbTitle" class="input" placeholder="e.g., Retail Visit v1" />
    <hr class="sep" />
    <div id="fbFields"></div>
  </div>
</div>

<!-- NEW SHOPPER MODAL -->
<div id="shopperModal" class="modal">
  <div class="modal-card">
    <div class="section-title"><h3>New Shopper/User</h3><button class="btn small" onclick="App.ui.closeModal('shopperModal')">Close</button></div>
    <div class="row"><div><label>Name</label><input id="nsName" class="input" /></div><div><label>Email</label><input id="nsEmail" class="input" /></div></div>
    <div class="row"><div><label>Password</label><input id="nsPass" type="password" class="input" /></div><div><label>Role</label><select id="nsRole" class="input"><option>Shopper</option><option>Admin</option></select></div></div>
    <div class="row"><div><label>Status</label><select id="nsStatus" class="input"><option>pending</option><option>active</option><option>disabled</option></select></div><div></div></div>
    <div class="row"><button class="btn ok" onclick="App.admin.saveNewShopper()">Save</button></div>
  </div>
</div>

<!-- NEW STORE MODAL -->
<div id="storeModal" class="modal">
  <div class="modal-card">
    <div class="section-title"><h3>New Store</h3><button class="btn small" onclick="App.ui.closeModal('storeModal')">Close</button></div>
    <div class="row"><div><label>Name</label><input id="stName" class="input" /></div><div><label>City</label><input id="stCity" class="input" /></div></div>
    <label>Address</label><input id="stAddress" class="input" />
    <label>Notes</label><textarea id="stNotes" class="input" rows="3"></textarea>
    <div class="row"><button class="btn ok" onclick="App.admin.saveNewStore()">Save</button></div>
  </div>
</div>

<!-- NEW ASSIGNMENT MODAL -->
<div id="assignModal" class="modal">
  <div class="modal-card">
    <div class="section-title"><h3>New Assignment</h3><button class="btn small" onclick="App.ui.closeModal('assignModal')">Close</button></div>
    <div class="row">
      <div><label>Shopper</label><select id="asShopper" class="input"></select></div>
      <div><label>Store</label><select id="asStore" class="input"></select></div>
    </div>
    <div class="row">
      <div><label>Form</label><select id="asForm" class="input"></select></div>
      <div><label>Window</label>
        <div class="row"><input id="asFrom" class="input" type="datetime-local"/><input id="asTo" class="input" type="datetime-local"/></div>
      </div>
    </div>
    <div class="row"><button class="btn ok" onclick="App.admin.saveAssignment()">Create</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ================= API client (REST direct SQL) =================
const API = {
  base: 'https://backend.wedaevents.com/ms-api.php',   // endpoint-ul tÄƒu
  token: localStorage.getItem('ms_token') || null,

  async call(q, method='GET', body=null, asText=false){
    const opt = { method, headers: {'Content-Type':'application/json'} };
    if(this.token) opt.headers['Authorization'] = 'Bearer '+this.token;
    if(body) opt.body = JSON.stringify(body);
    const r = await fetch(this.base + '?q=' + encodeURIComponent(q), opt);
    if(asText) return r.text();
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if(!r.ok || j.ok===false){ throw new Error(j.error || ('HTTP '+r.status)); }
    return j;
  },
  setToken(t){ this.token=t; localStorage.setItem('ms_token', t); },
  clearToken(){ this.token=null; localStorage.removeItem('ms_token'); }
};

// ============= Utils (la fel ca Ã®nainte, puÈ›in mai scurt) =============
const U = {
  uid: ()=>'id_'+Math.random().toString(36).slice(2)+Date.now().toString(36),
  fmtDT(ts){ if(!ts) return ''; return new Date(parseInt(ts,10)).toLocaleString(); },
  pad(n){ return (n<10?'0':'')+n; },
  fmtDuration(sec){ sec=Math.max(0,Math.floor(sec||0)); const m=Math.floor(sec/60), s=sec%60; return U.pad(m)+':'+U.pad(s); },
  toast(msg,ms=2200){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
};
const App = {
  state:{ me:null, role:'Guest', timer:{running:false,start:0,interval:null}, curAssign:null, curForm:null, curSubmission:null },
  cache:{ users:[], stores:[], forms:[], assignments:[], submissions:[] },

  async init(){
    this.bindUI();
    await this.tryBootstrap(); // dacÄƒ existÄƒ token, trage datele
  },

  async tryBootstrap(){
    try{
      const boot = await API.call('bootstrap','GET');
      this.state.me = boot.me;
      this.cache = { users:boot.users||[], stores:boot.stores||[], forms:boot.forms||[], assignments:boot.assignments||[], submissions:boot.submissions||[] };
      this.ui.updateAuthTabs();
      this.ui.setRole(this.state.me?.role || 'Guest');
      this.ui.showView(this.state.me?.role==='Admin'?'admin':'shopper');
      this.admin.loadAll();
      this.refreshTasks();
    }catch(e){
      this.ui.updateAuthTabs(); // guest
    }
  },

  async reload(){ await this.tryBootstrap(); },

  bindUI(){
    const $=sel=>document.querySelector(sel);
    $('#tabShopper').onclick = ()=>this.ui.showView('shopper');
    $('#tabAdmin').onclick   = ()=>this.ui.showView('admin');
    $('#tabAuth').onclick    = ()=>this.ui.showAuth(true);
    $('#tabProfile').onclick = ()=>this.profile.open();
    $('#tabLogout').onclick  = ()=>this.auth.logout();
    document.getElementById('seedInfo').textContent="Login seed: admin@example.com / admin";
  },

  ui:{
    showView(which){
      if(which==='admin' && (!App.state.me || App.state.me.role!=='Admin')){ U.toast('Admins only'); which='shopper'; }
      const s=id=>document.getElementById(id);
      s('viewShopper').classList.toggle('hidden', which!=='shopper');
      s('viewAdmin').classList.toggle('hidden', which!=='admin');
      document.getElementById('tabShopper').classList.toggle('active', which==='shopper');
      document.getElementById('tabAdmin').classList.toggle('active', which==='admin');
    },
    setRole(r){
      App.state.role=r||'Guest';
      const b=document.getElementById('roleBadge');
      b.textContent=r||'Guest';
      b.className='pill-inline '+(r==='Admin'?'badge-ok':r==='Shopper'?'badge-warn':'badge-danger');
    },
    updateAuthTabs(){
      const me=App.state.me;
      const show=(id,on)=>document.getElementById(id).classList.toggle('hidden', !on);
      show('tabAuth', !me); show('tabProfile', !!me); show('tabLogout', !!me);
      document.getElementById('tabAdmin').classList.toggle('hidden', !(me && me.role==='Admin'));
      document.getElementById('tabAdmin').toggleAttribute('disabled', !(me && me.role==='Admin'));
    },
    showAuth(open=true){ document.getElementById('authModal').style.display=open?'flex':'none'; },
    hideAuth(){ this.showAuth(false); },
    openModal(id){ document.getElementById(id).style.display='flex'; },
    closeModal(id){ document.getElementById(id).style.display='none'; }
  },

  // ================= AUTH =================
  auth:{
    async login(){
      const user=document.getElementById('loginUser').value.trim();
      const pass=document.getElementById('loginPass').value;
      try{
        const j=await API.call('auth/login','POST',{user,pass});
        API.setToken(j.token); App.state.me=j.user;
        App.ui.hideAuth(); await App.reload(); U.toast('Logged in');
      }catch(e){ U.toast(e.message); }
    },
    openRegister(){ document.getElementById('registerBox').classList.remove('hidden'); },
    async register(){
      const name=document.getElementById('regName').value.trim();
      const email=document.getElementById('regEmail').value.trim();
      const pass1=document.getElementById('regPass1').value, pass2=document.getElementById('regPass2').value;
      if(!name||!email||!pass1||pass1!==pass2) return U.toast('CompleteazÄƒ corect');
      try{ await API.call('auth/register','POST',{name,email,pass:pass1}); U.toast('Created. Await admin approval.'); }
      catch(e){ U.toast(e.message); }
    },
    async logout(){ API.clearToken(); App.state.me=null; App.ui.updateAuthTabs(); App.ui.showView('shopper'); U.toast('Logged out'); }
  },

  // ================= PROFILE =================
  profile:{
    open(){ if(!App.state.me) return U.toast('Login first');
      document.getElementById('pfName').value=App.state.me.name||'';
      document.getElementById('pfEmail').value=App.state.me.email||'';
      document.getElementById('pfRole').value=App.state.me.role||'';
      document.getElementById('pfCurPass').value=''; document.getElementById('pfNewPass1').value=''; document.getElementById('pfNewPass2').value='';
      App.ui.openModal('profileModal');
    },
    async save(){
      const name=document.getElementById('pfName').value.trim();
      const email=document.getElementById('pfEmail').value.trim();
      const cur=document.getElementById('pfCurPass').value;
      const n1=document.getElementById('pfNewPass1').value, n2=document.getElementById('pfNewPass2').value;
      if(n1||n2){ if(n1!==n2) return U.toast('Parolele nu coincid'); }
      try{
        await API.call('me/update','PATCH',{name,email,curPass:cur,newPass:n1||''});
        await App.reload(); App.ui.closeModal('profileModal'); U.toast('Profile updated');
      }catch(e){ U.toast(e.message); }
    }
  },

  // ================= SHOPPER VIEW =================
  refreshTasks(){
    const me=App.state.me; const tbody=document.querySelector('#tasksTable tbody'); tbody.innerHTML='';
    let tasks = (App.cache.assignments||[]).filter(a=>me && a.shopper_id===me.id);
    if(!tasks.length) document.getElementById('tasksEmpty').classList.remove('hidden'); else document.getElementById('tasksEmpty').classList.add('hidden');
    tasks.sort((a,b)=>(a.window_from||0)-(b.window_from||0));
    tasks.forEach(a=>{
      const store = App.cache.stores.find(s=>s.id===a.store_id);
      const form  = App.cache.forms.find(f=>f.id===a.form_id);
      const sub   = App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);
      const status= sub? (sub.status||'submitted') : (a.status||'assigned');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${store?store.name:''} â€” <span class="sub">${form?form.title:''}</span></td>
        <td>${a.window_from?new Date(a.window_from).toLocaleString():''}${a.window_to?' â€“ '+new Date(a.window_to).toLocaleString():''}</td>
        <td>${status}</td>
        <td><button class="btn small" onclick="App.openAssignment('${a.id}')">Open</button></td>`;
      tbody.appendChild(tr);
    });
  },

  async openAssignment(assignId){
    const a = App.cache.assignments.find(x=>x.id===assignId); if(!a) return;
    const store = App.cache.stores.find(s=>s.id===a.store_id)||{};
    const form  = App.cache.forms.find(f=>f.id===a.form_id)||{fields:[],title:'Form'};
    let sub = App.cache.submissions.find(s=>s.assignment_id===a.id && s.shopper_id===a.shopper_id);

    if(!sub){
      // creeazÄƒ submission la server
      const res = await API.call('submissions/upsert','POST',{
        assignmentId:a.id, shopperId:a.shopper_id, storeId:a.store_id, formId:a.form_id
      });
      await App.reload(); sub = App.cache.submissions.find(s=>s.id===res.id);
    }

    this.state.curAssign=a; this.state.curForm=form; this.state.curSubmission=sub;

    document.getElementById('visitCard').classList.remove('hidden');
    document.getElementById('visitTitle').textContent=`Visit â€” ${form.title}`;
    document.getElementById('visitStore').textContent=store.name||'';
    document.getElementById('visitAddress').textContent=store.address||'';
    const win=a.window_from? (new Date(a.window_from).toLocaleString() + (a.window_to?' â€“ '+new Date(a.window_to).toLocaleString():'')) : '';
    document.getElementById('visitWindow').textContent=win;

    document.getElementById('fldStartedAt').value=sub.started_at?U.fmtDT(sub.started_at):'';
    document.getElementById('fldStoppedAt').value=sub.stopped_at?U.fmtDT(sub.stopped_at):'';
    document.getElementById('fldDuration').value=sub.duration_sec?U.fmtDuration(sub.duration_sec):'';
    document.getElementById('fldGeoStart').value=sub.geo_start||'';
    document.getElementById('fldGeoStop').value=sub.geo_stop||'';

    const host=document.getElementById('dynamicForm'); host.innerHTML='';
    form.fields.forEach(f=>{
      const wrap=document.createElement('div'); wrap.style.marginBottom='10px';
      wrap.innerHTML=`<label>${f.label}${f.required? ' <span class="sub">(required)</span>':''}</label>`;
      let el=null; const val=(sub.values||{})[f.id]??'';
      if(f.type==='textarea'){ el=document.createElement('textarea'); el.className='input'; el.rows=3; el.value=val; }
      else if(f.type==='number' || f.type==='rating'){ el=document.createElement('input'); el.className='input'; el.type='number'; el.value=val; if(f.type==='rating'){ el.min=1; el.max=5; el.step=1; el.placeholder='1-5'; } }
      else if(f.type==='yesno'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option><option>Yes</option><option>No</option>'; el.value=val; }
      else if(f.type==='select'){ el=document.createElement('select'); el.className='input'; el.innerHTML='<option value="">Select</option>'+ (f.options||[]).map(o=>`<option>${o}</option>`).join(''); el.value=val; }
      else { el=document.createElement('input'); el.className='input'; el.value=val; }
      // debounce save
      let t=null; el.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>App.submission.saveField(f.id, el.value), 350); };
      wrap.appendChild(el); host.appendChild(wrap);
    });
  },

  submission:{
    async saveField(fid, val){
      const s=App.state.curSubmission; if(!s) return;
      await API.call('submissions/update-values','PATCH',{id:s.id, patch:{[fid]:val}});
      // actualizeazÄƒ local cache minim
      const loc = App.cache.submissions.find(x=>x.id===s.id);
      if(loc){ loc.values = loc.values || {}; loc.values[fid]=val; }
    }
  },

  async saveDraft(){
    const s=this.state.curSubmission; if(!s) return;
    await API.call('submissions/upsert','POST',{id:s.id,status:'draft'});
    await this.reload(); U.toast('Draft saved');
  },

  async submitForm(){
    const s=this.state.curSubmission, f=this.state.curForm; if(!s||!f) return;
    // validÄƒri minime: cerem sÄƒ fie stopat timerul
    if(!s.started_at || !s.stopped_at) return U.toast('Stop the timer before submitting');
    await API.call('submissions/upsert','POST',{id:s.id,status:'submitted',submittedAt:Date.now()});
    await this.reload(); U.toast('Submitted');
  },

  // ================= TIMER =================
  timer:{
    async start(){
      const s=App.state.curSubmission; if(!s) return U.toast('Open a task first');
      if(s.started_at) return U.toast('Timer already started');
      let geo=null; if(navigator.geolocation){ try{
        geo = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(p=>res(p),e=>res(null)));
      }catch(_){/*ignore*/} }
      const started=Date.now();
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:started, geoStart: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null});
      await App.reload();
      App.state.timer.running=true; App.state.timer.start=started;
      document.getElementById('timerOverlay').style.display='flex';
      App.state.timer.interval=setInterval(()=>{
        const secs=(Date.now()-App.state.timer.start)/1000;
        document.getElementById('timerDigits').textContent=U.fmtDuration(secs);
        document.getElementById('timerMeta').textContent='Started at '+U.fmtDT(App.state.timer.start);
      },250);
    },
    async stop(){
      const s=App.state.curSubmission; if(!s || !App.state.timer.running) return;
      let geo=null; if(navigator.geolocation){ try{
        geo = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(p=>res(p),e=>res(null)));
      }catch(_){/*ignore*/} }
      const stopped=Date.now(); const dur=Math.floor((stopped - App.state.timer.start)/1000);
      await API.call('submissions/upsert','POST',{id:s.id, stoppedAt:stopped, durationSec:dur, geoStop: geo?(`${geo.coords.latitude.toFixed(5)}, ${geo.coords.longitude.toFixed(5)}`):null });
      clearInterval(App.state.timer.interval); App.state.timer.running=false;
      document.getElementById('timerOverlay').style.display='none';
      await App.reload(); U.toast('Timer stopped');
    },
    async reset(){
      const s=App.state.curSubmission; if(!s) return;
      if(App.state.timer.running) return U.toast('Stop timer first');
      await API.call('submissions/upsert','POST',{id:s.id, startedAt:null, stoppedAt:null, durationSec:null, geoStart:'', geoStop:''});
      await App.reload(); U.toast('Visit times cleared');
    }
  },

  // ================= ADMIN =================
  admin:{
    selectedPanel:'shoppers',
    switchPanel(which){
      this.selectedPanel=which;
      ['forms','shoppers','stores'].forEach(p=>{
        document.getElementById('panel'+p.charAt(0).toUpperCase()+p.slice(1)).classList.toggle('hidden', p!==which);
        document.getElementById('mi'+p.charAt(0).toUpperCase()+p.slice(1)).classList.toggle('active', p===which);
      });
    },
    async syncNow(){ await App.reload(); U.toast('Synced'); },

    loadAll(){
      // Forms
      const tf=document.querySelector('#tblForms tbody'); if(tf){ tf.innerHTML='';
        (App.cache.forms||[]).forEach(f=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${f.title}</td><td>${(f.fields||[]).length}</td>
            <td><button class="btn small" onclick="App.admin.openFormBuilder('${f.id}')">Edit</button>
                <button class="btn danger small" onclick="App.admin.deleteForm('${f.id}')">Delete</button></td>`;
          tf.appendChild(tr);
        });
      }
      // Users
      const ts=document.querySelector('#tblShoppers tbody'); if(ts){ ts.innerHTML='';
        (App.cache.users||[]).forEach(u=>{
          const info=document.createElement('tr');
          info.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.status} <span class="pill-inline">${u.role}</span></td><td></td>`; ts.appendChild(info);
          const actions=document.createElement('tr'); actions.className='user-actions';
          actions.innerHTML=`<td colspan="4"><div class="actions">
              <button class="btn small" onclick="App.admin.userSetStatus('${u.id}','active')">Activate</button>
              <button class="btn small" onclick="App.admin.userSetStatus('${u.id}','pending')">Pending</button>
              <button class="btn small" onclick="App.admin.userSetStatus('${u.id}','disabled')">Disable</button>
              <button class="btn danger small" onclick="App.admin.deleteUser('${u.id}')">Delete</button>
            </div><div class="divider"></div></td>`; ts.appendChild(actions);
        });
      }
      // Stores
      const tstore=document.querySelector('#tblStores tbody'); if(tstore){ tstore.innerHTML='';
        (App.cache.stores||[]).forEach(s=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${s.name}</td><td>${s.city||''}</td>
            <td><button class="btn small" onclick="App.admin.editStore('${s.id}')">Edit</button>
                <button class="btn danger small" onclick="App.admin.deleteStore('${s.id}')">Delete</button></td>`;
          tstore.appendChild(tr);
        });
      }
      // Assignments
      const ta=document.querySelector('#tblAssign tbody'); if(ta){ ta.innerHTML='';
        (App.cache.assignments||[]).forEach(a=>{
          const sh=App.cache.users.find(u=>u.id===a.shopper_id);
          const st=App.cache.stores.find(s=>s.id===a.store_id);
          const f =App.cache.forms.find(x=>x.id===a.form_id);
          const sub=App.cache.submissions.find(s=>s.assignment_id===a.id);
          const status=sub?(sub.status||'submitted'):(a.status||'assigned');
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${sh?sh.name:''}</td><td>${st?st.name:''}</td><td>${f?f.title:''}</td>
            <td>${a.window_from?new Date(a.window_from).toLocaleString():''}${a.window_to?' â€“ '+new Date(a.window_to).toLocaleString():''}</td>
            <td>${status}</td>
            <td><button class="btn small" onclick="App.admin.openAssignment('${a.id}')">Open</button>
                <button class="btn danger small" onclick="App.admin.deleteAssignment('${a.id}')">Delete</button></td>`;
          ta.appendChild(tr);
        });
      }
      // Submissions
      const tsu=document.querySelector('#tblSubm tbody'); if(tsu){ tsu.innerHTML='';
        (App.cache.submissions||[]).forEach(s=>{
          const st=App.cache.stores.find(o=>o.id===s.store_id)||{}; const sh=App.cache.users.find(o=>o.id===s.shopper_id)||{};
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${st.name||''}</td><td>${sh.name||''}</td><td>${s.duration_sec?U.fmtDuration(s.duration_sec):''}</td>
            <td>${s.status||''}</td>
            <td><button class="btn small" onclick="App.admin.viewSubmission('${s.id}')">View</button>
                <button class="btn small" onclick="App.admin.markSubmission('${s.id}','approved')">Approve</button>
                <button class="btn small" onclick="App.admin.markSubmission('${s.id}','rejected')">Reject</button>
                <button class="btn danger small" onclick="App.admin.deleteSubmission('${s.id}')">Delete</button></td>`;
          tsu.appendChild(tr);
        });
      }
    },

    // Users
    openNewShopper(){ App.ui.openModal('shopperModal'); },
    async saveNewShopper(){
      const name=document.getElementById('nsName').value.trim();
      const email=document.getElementById('nsEmail').value.trim();
      const pass=document.getElementById('nsPass').value;
      const role=document.getElementById('nsRole').value;
      const status=document.getElementById('nsStatus').value;
      if(!name||!email||!pass) return U.toast('Fill all');
      await API.call('users/create','POST',{name,email,pass,role,status});
      App.ui.closeModal('shopperModal'); await App.reload(); U.toast('User saved');
    },
    async userSetStatus(id,status){ await API.call('users/update','PATCH',{id,status}); await App.reload(); U.toast('User '+status); },
    async deleteUser(id){ await API.call('users/delete','DELETE',{id}); await App.reload(); U.toast('User deleted'); },

    // Stores
    openNewStore(){ App.ui.openModal('storeModal'); const b=document.querySelector('#storeModal .btn.ok'); b.onclick=()=>App.admin.saveNewStore(); },
    async saveNewStore(){
      const name=document.getElementById('stName').value.trim();
      const city=document.getElementById('stCity').value.trim();
      const address=document.getElementById('stAddress').value.trim();
      const notes=document.getElementById('stNotes').value.trim();
      if(!name) return U.toast('Name required');
      await API.call('stores/create','POST',{name,city,address,notes});
      App.ui.closeModal('storeModal'); await App.reload(); U.toast('Store saved');
    },
    editStore(id){
      const s=App.cache.stores.find(x=>x.id===id); if(!s) return;
      App.ui.openModal('storeModal');
      document.getElementById('stName').value=s.name; document.getElementById('stCity').value=s.city||'';
      document.getElementById('stAddress').value=s.address||''; document.getElementById('stNotes').value=s.notes||'';
      const b=document.querySelector('#storeModal .btn.ok');
      b.onclick=async ()=>{
        await API.call('stores/update','PATCH',{id:s.id,name:document.getElementById('stName').value,city:document.getElementById('stCity').value,address:document.getElementById('stAddress').value,notes:document.getElementById('stNotes').value});
        App.ui.closeModal('storeModal'); await App.reload(); U.toast('Store updated');
      };
    },
    async deleteStore(id){ await API.call('stores/delete','DELETE',{id}); await App.reload(); U.toast('Store deleted'); },

    // Forms
    _editingFormId:null, _fbForm:{id:null,title:'',fields:[]},
    openFormBuilder(id=null){
      this._editingFormId=id;
      if(id){ const f=App.cache.forms.find(x=>x.id===id); this._fbForm=JSON.parse(JSON.stringify(f)); }
      else this._fbForm={id:null,title:'',fields:[]};
      document.getElementById('fbTitle').value=this._fbForm.title||'';
      App.admin.renderFBFields(); App.ui.openModal('formModal');
    },
    renderFBFields(){
      const host=document.getElementById('fbFields'); host.innerHTML='';
      const form=this._fbForm;
      if(!form.fields.length){ host.innerHTML='<div class="sub">No fields yet. Click "Add field".</div>'; return; }
      form.fields.forEach((f,idx)=>{
        const box=document.createElement('div'); box.className='card';
        box.innerHTML=`
          <div class="section-title"><h3>Field ${idx+1}</h3>
            <div class="row" style="gap:6px">
              <button class="btn small" onclick="App.admin.moveField(${idx},-1)">â†‘</button>
              <button class="btn small" onclick="App.admin.moveField(${idx},1)">â†“</button>
              <button class="btn danger small" onclick="App.admin.delField(${idx})">Delete</button>
            </div>
          </div>
          <div class="row">
            <div><label>Label</label><input class="input" value="${f.label||''}" oninput="App.admin.updateField(${idx},'label',this.value)"/></div>
            <div><label>Type</label>
              <select class="input" onchange="App.admin.updateField(${idx},'type',this.value)">
                ${['text','textarea','number','yesno','select','rating'].map(t=>`<option ${f.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div><label>Required</label>
              <select class="input" onchange="App.admin.updateField(${idx},'required',this.value==='true')">
                <option value="false" ${!f.required?'selected':''}>No</option>
                <option value="true" ${f.required?'selected':''}>Yes</option>
              </select>
            </div>
          </div>
          <div ${f.type==='select'?'':'class="hidden"'} id="opt_${idx}">
            <label>Options (comma separated)</label>
            <input class="input" value="${(f.options||[]).join(', ')}" oninput="App.admin.updateOptions(${idx}, this.value)"/>
          </div>`;
        host.appendChild(box);
      });
    },
    addFieldUI(){ this._fbForm.fields.push({id:U.uid(),label:'New field',type:'text',required:false,options:[]}); this.renderFBFields(); },
    moveField(i,dir){ const a=this._fbForm.fields; const j=i+dir; if(j<0||j>=a.length) return; [a[i],a[j]]=[a[j],a[i]]; this.renderFBFields(); },
    delField(i){ this._fbForm.fields.splice(i,1); this.renderFBFields(); },
    updateField(i,k,v){ this._fbForm.fields[i][k]=v; if(k==='type') setTimeout(()=>this.renderFBFields(),0); },
    updateOptions(i,raw){ this._fbForm.fields[i].options = raw.split(',').map(s=>s.trim()).filter(Boolean); },
    async saveForm(){
      const title=document.getElementById('fbTitle').value.trim(); if(!title) return U.toast('Title required');
      this._fbForm.title=title;
      await API.call('forms/save','POST', this._fbForm);
      App.ui.closeModal('formModal'); await App.reload(); U.toast('Form saved');
    },
    async deleteForm(id){ await API.call('forms/delete','DELETE',{id}); await App.reload(); U.toast('Form deleted'); },

    // Assignments
    openAssignment(id=null){
      const shoppers = App.cache.users.filter(u=>u.status==='active');
      const stores   = App.cache.stores;
      const forms    = App.cache.forms;
      const s1=document.getElementById('asShopper'); s1.innerHTML=shoppers.map(u=>`<option value="${u.id}">${u.name} â€” ${u.email}</option>`).join('');
      const s2=document.getElementById('asStore');   s2.innerHTML=stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      const s3=document.getElementById('asForm');    s3.innerHTML=forms.map(f=>`<option value="${f.id}">${f.title}</option>`).join('');
      document.getElementById('asFrom').value=''; document.getElementById('asTo').value='';
      App.ui.openModal('assignModal');
    },
    async saveAssignment(){
      const shopperId=document.getElementById('asShopper').value;
      const storeId=document.getElementById('asStore').value;
      const formId=document.getElementById('asForm').value;
      const from=document.getElementById('asFrom').value? new Date(document.getElementById('asFrom').value).getTime():null;
      const to  =document.getElementById('asTo').value?   new Date(document.getElementById('asTo').value).getTime():null;
      if(!shopperId||!storeId||!formId) return U.toast('Pick shopper, store and form');
      await API.call('assignments/create','POST',{shopperId,storeId,formId,from,to});
      App.ui.closeModal('assignModal'); await App.reload(); U.toast('Assignment created');
    },
    async deleteAssignment(id){ await API.call('assignments/delete','DELETE',{id}); await App.reload(); U.toast('Assignment deleted'); },

    // Submissions (admin actions)
    async markSubmission(id,state){ await API.call('submissions/mark','PATCH',{id,status:state}); await App.reload(); U.toast('Submission '+state); },
    async deleteSubmission(id){ await API.call('submissions/delete','DELETE',{id}); await App.reload(); U.toast('Submission deleted'); },

    viewSubmission(id){
      // (pÄƒstrÄƒm viewerul light exact ca Ã®nainte)
      const s = App.cache.submissions.find(x=>x.id===id); if(!s) return U.toast('Missing');
      const st= App.cache.stores.find(o=>o.id===s.store_id)||{};
      const f = App.cache.forms.find(o=>o.id===s.form_id)||{fields:[],title:'Form'};
      const sh= App.cache.users.find(o=>o.id===s.shopper_id)||{};
      const esc = (v)=> (v==null?'':String(v).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])));
      const nl2br = (v)=> esc(v).replace(/\n/g,'<br>');
      const star = (n)=>{ const v=Math.max(1,Math.min(5,parseInt(n||0,10)||0)); return `<span style="font-size:16px">${'â˜…'.repeat(v)}${'â˜†'.repeat(5-v)}</span><span style="margin-left:6px;font-size:12px;color:#666">${v}/5</span>`; };
      const valueFor=(fld,val)=> val==null||val===''?'<span style="color:#999">â€“</span>':(fld.type==='textarea'?nl2br(val):fld.type==='rating'?star(val):esc(val));
      const rows=(f.fields||[]).map(fl=>`<tr><th>${esc(fl.label)}</th><td>${valueFor(fl,(s.values||{})[fl.id])}</td></tr>`).join('')||`<tr><td colspan="2" style="color:#777;padding:12px 0">No fields</td></tr>`;
      const doc=window.open('','_blank');
      doc.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Submission ${esc(s.id)}</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>:root{--ink:#111;--muted:#6b7280;--paper:#FAFAFC;--line:#e5e7eb;--card:#fff}*{box-sizing:border-box}html,body{margin:0;background:var(--paper);color:var(--ink);font-family:"DM Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial}.container{max-width:900px;margin:0 auto;padding:28px 20px 60px}.doc{background:var(--card);border:1px solid var(--line);border-radius:14px}.head{padding:22px 22px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}.logo{width:34px;height:34px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:700}.chips{display:flex;gap:8px;flex-wrap:wrap}.chip{padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#374151;background:#fff}.meta{padding:14px 22px 8px;display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:800px){.meta{grid-template-columns:1fr}}.toolbar{padding:10px 22px;display:flex;gap:8px;border-bottom:1px solid var(--line)}.btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:13px}.btn.primary{background:#111;color:#fff;border-color:#111}.content{padding:16px 22px 26px}table{width:100%;border-collapse:collapse}th,td{text-align:left;vertical-align:top;padding:10px 8px;border-bottom:1px solid var(--line)}th{width:28%;color:#374151;font-weight:600}.foot{padding:14px 22px;border-top:1px solid var(--line);color:#6b7280;font-size:12px}@media print{.toolbar{display:none}body{background:#fff}.doc{box-shadow:none}}</style></head><body>
<div class="container"><div class="doc">
<div class="head"><div style="display:flex;gap:10px;align-items:center"><div class="logo">MS</div><div><h1 style="font-size:18px;margin:0">Submission <span style="color:#6b7280">#${esc(s.id)}</span></h1>
<div class="chips"><span class="chip"><b>Form:</b> ${esc(f.title)}</span><span class="chip"><b>Store:</b> ${esc(st.name||'')}</span><span class="chip"><b>Shopper:</b> ${esc(sh.name||'')}</span><span class="chip">${esc(s.status||'')}</span></div></div></div>
<div style="color:#6b7280">Generated: ${esc(new Date().toLocaleString())}</div></div>
<div class="meta"><div><b>Started:</b> ${esc(U.fmtDT(s.started_at))}</div><div><b>Stopped:</b> ${esc(U.fmtDT(s.stopped_at))}</div><div><b>Duration:</b> ${esc(U.fmtDuration(s.duration_sec||0))}</div><div><b>Geo:</b> ${esc(s.geo_start||'â€“')} â†’ ${esc(s.geo_stop||'â€“')}</div></div>
<div class="toolbar"><button class="btn primary" onclick="window.print()">Print</button><button class="btn" onclick="window.close()">Close</button></div>
<div class="content"><table>${rows}</table></div>
<div class="foot">Stored in MySQL (live API).</div></div></div>
<script>(function(){})();<\/script></body></html>`); doc.document.close();
    }
  }
};

window.addEventListener('load', ()=>App.init());
</script>
</body>
</html>
